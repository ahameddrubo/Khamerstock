<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Management System</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
#login-section { max-width: 400px; margin: auto; }
#login-section input, #login-section select { width: 100%; margin: 5px 0; padding: 8px; }
#admin-panel, #user-panel { display: none; max-width: 800px; margin: auto; }
h1, h2, h3 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin: 10px 0; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: center; }
button { padding: 6px 12px; margin: 4px; }
.low-stock { background: #fdd; }
</style>
</head>
<body>

<div id="login-section">
  <h1>স্টক ম্যানেজমেন্ট সিস্টেম</h1>
  <h2>অ্যাডমিন লগইন</h2>
  <input type="email" id="adminEmail" placeholder="ইমেইল"/>
  <input type="password" id="adminPass" placeholder="পাসওয়ার্ড"/>
  <button id="adminLoginBtn">লগইন</button>
  <hr>
  <h2>ইউজার প্যানেল (পাসওয়ার্ড)</h2>
  <select id="userCat">
    <option value="Kitchen">Kitchen (KhamerK)</option>
    <option value="Men">Men (KhamerM)</option>
    <option value="Women">Women (KhamerF)</option>
  </select>
  <input type="password" id="userPass" placeholder="পাসওয়ার্ড"/>
  <button id="userLoginBtn">সাইন ইন</button>
</div>

<div id="admin-panel">
  <h1>অ্যাডমিন ড্যাশবোর্ড</h1>
  <h2>অর্ডারসমূহ</h2>
  <table id="orderTable">
    <tr><th>Order ID</th><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr>
  </table>
  <h2>পণ্যসমূহ</h2>
  <table id="productTable">
    <tr><th>Product ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th></tr>
  </table>
  <h3>Add Product</h3>
  <input type="text" id="prodName" placeholder="পণ্যের নাম"/>
  <input type="number" id="prodPrice" placeholder="মূল্য"/>
  <input type="number" id="prodStock" placeholder="স্টক"/>
  <select id="prodCat">
    <option value="Kitchen">Kitchen</option>
    <option value="Men">Men</option>
    <option value="Women">Women</option>
  </select>
  <button id="addProdBtn">Add Product</button>
  <h3>Monthly Report</h3>
  <button id="genReportBtn">Generate PDF Report</button>
</div>

<div id="user-panel">
  <h1 id="userTitle">User Panel</h1>
  <h2>Products</h2>
  <div id="prodList"></div>
  <h2>My Orders</h2>
  <table id="myOrdersTable">
    <tr><th>Order ID</th><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBnvcS8kpOrebq66LzQ2hz5Kvv_z_pu5p4",
  authDomain: "stock-5d278.firebaseapp.com",
  projectId: "stock-5d278",
  storageBucket: "stock-5d278.firebasestorage.app",
  messagingSenderId: "730697386577",
  appId: "1:730697386577:web:8b7ef78adac14ee5990670",
  measurementId: "G-CFNVGX1S4W"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserCategory = null;

// অ্যাডমিন লগইন
document.getElementById('adminLoginBtn').addEventListener('click', function(){
  const email = document.getElementById('adminEmail').value;
  const pass = document.getElementById('adminPass').value;
  auth.signInWithEmailAndPassword(email, pass)
    .then(userCredential => {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      loadOrders();
      loadProducts();
    })
    .catch(err => alert('Login Failed: ' + err.message));
});

// ইউজার লগইন (স্ট্যাটিক পাস)
document.getElementById('userLoginBtn').addEventListener('click', function(){
  const cat = document.getElementById('userCat').value;
  const pass = document.getElementById('userPass').value;
  if((cat=='Kitchen' && pass=='KhamerK') ||
     (cat=='Men' && pass=='KhamerM') ||
     (cat=='Women' && pass=='KhamerF')) {
    currentUserCategory = cat;
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('user-panel').style.display = 'block';
    document.getElementById('userTitle').innerText = cat + ' Panel';
    loadProductsForCategory(cat);
    loadMyOrders(cat);
  } else {
    alert('অবৈধ পাসওয়ার্ড বা বিভাগ');
  }
});

// নতুন পণ্য যোগ
document.getElementById('addProdBtn').addEventListener('click', function(){
  const name = document.getElementById('prodName').value;
  const price = parseFloat(document.getElementById('prodPrice').value);
  const stock = parseInt(document.getElementById('prodStock').value);
  const category = document.getElementById('prodCat').value;
  if(name && !isNaN(price) && !isNaN(stock)) {
    db.collection('products').add({ name, price, stock, category });
    loadProducts();
  }
});

// অ্যাডমিন প্যানেলে পণ্য লোড
function loadProducts() {
  const table = document.getElementById('productTable');
  table.innerHTML = '<tr><th>Product ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th></tr>';
  db.collection('products').get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = table.insertRow(-1);
      row.insertCell(0).innerText = doc.id;
      row.insertCell(1).innerText = data.name;
      row.insertCell(2).innerText = data.category;
      row.insertCell(3).innerText = data.price;
      const stockCell = row.insertCell(4);
      stockCell.innerText = data.stock;
      if(data.stock <= 5) row.classList.add('low-stock');
    });
  });
}

// অ্যাডমিন প্যানেলে অর্ডার লোড
function loadOrders() {
  const table = document.getElementById('orderTable');
  table.innerHTML = '<tr><th>Order ID</th><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr>';
  db.collection('orders').get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = table.insertRow(-1);
      row.insertCell(0).innerText = doc.id;
      row.insertCell(1).innerText = data.productName || '';
      row.insertCell(2).innerText = data.qty;
      row.insertCell(3).innerText = data.status;
      const actionCell = row.insertCell(4);
      if(data.status === 'Ordered') {
        const btnDeliver = document.createElement('button');
        btnDeliver.innerText = 'Deliver';
        btnDeliver.onclick = () => updateOrderStatus(doc.id, 'Delivered', data);
        actionCell.appendChild(btnDeliver);
        const btnCancel = document.createElement('button');
        btnCancel.innerText = 'Cancel';
        btnCancel.onclick = () => updateOrderStatus(doc.id, 'Cancelled');
        actionCell.appendChild(btnCancel);
      }
    });
  });
}

// অর্ডার স্ট্যাটাস আপডেট
function updateOrderStatus(orderId, status, orderData) {
  db.collection('orders').doc(orderId).update({ status });
  if(status === 'Delivered' && orderData) {
    const prodRef = db.collection('products').doc(orderData.productId);
    prodRef.get().then(doc => {
      if(doc.exists) {
        const newStock = doc.data().stock - orderData.qty;
        prodRef.update({ stock: newStock });
        loadProducts();
      }
    });
  }
  loadOrders();
}

// নির্দিষ্ট বিভাগ থেকে পণ্য দেখানো (ইউজার প্যানেল)
function loadProductsForCategory(cat) {
  const listDiv = document.getElementById('prodList');
  listDiv.innerHTML = '';
  db.collection('products').where('category','==',cat).get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      if(data.stock > 0) {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${data.name}</strong> (৳${data.price}) - Stock: ${data.stock} 
          <input type="number" id="qty_${doc.id}" min="1" max="${data.stock}" value="1" style="width:60px;"> 
          <button onclick="placeOrder('${doc.id}','${data.name}', ${data.stock})">Order</button>`;
        listDiv.appendChild(div);
      }
    });
  });
}

// অর্ডার করা (ইউজার প্যানেল)
function placeOrder(prodId, prodName, stock) {
  const qty = parseInt(document.getElementById('qty_' + prodId).value);
  if(qty > 0 && qty <= stock) {
    db.collection('orders').add({
      productId: prodId,
      productName: prodName,
      qty: qty,
      status: 'Ordered',
      userCategory: currentUserCategory,
      timestamp: firebase.firestore.Timestamp.now()
    });
    loadMyOrders(currentUserCategory);
    alert('অর্ডার করা হয়েছে');
  }
}

// ইউজারের অর্ডার দেখানো
function loadMyOrders(cat) {
  const table = document.getElementById('myOrdersTable');
  table.innerHTML = '<tr><th>Order ID</th><th>Product</th><th>Qty</th><th>Status</th><th>Action</th></tr>';
  db.collection('orders').where('userCategory','==',cat).get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      const row = table.insertRow(-1);
      row.insertCell(0).innerText = doc.id;
      row.insertCell(1).innerText = data.productName;
      row.insertCell(2).innerText = data.qty;
      row.insertCell(3).innerText = data.status;
      const actionCell = row.insertCell(4);
      if(data.status === 'Ordered') {
        const btnCancel = document.createElement('button');
        btnCancel.innerText = 'Cancel';
        btnCancel.onclick = () => db.collection('orders').doc(doc.id)
                              .update({status:'Cancelled'})
                              .then(()=>loadMyOrders(cat));
        actionCell.appendChild(btnCancel);
      }
    });
  });
}

// মাসিক রিপোর্ট জেনারেট (jsPDF ব্যবহার)
document.getElementById('genReportBtn').addEventListener('click', async function(){
  const { jsPDF } = window.jspdf;
  const docPDF = new jsPDF();
  docPDF.setFontSize(16);
  docPDF.text("Monthly Orders Report", 20, 20);
  let y = 30;
  const threeMonthsAgo = new Date(); threeMonthsAgo.setMonth(threeMonthsAgo.getMonth()-3);
  const snapshot = await db.collection('orders')
                       .orderBy('timestamp','desc')
                       .where('timestamp','>=', firebase.firestore.Timestamp.fromDate(threeMonthsAgo)).get();
  snapshot.forEach(orderDoc => {
    const d = orderDoc.data();
    docPDF.text(`Order ${orderDoc.id}: ${d.productName}, Qty: ${d.qty}, Status: ${d.status}`, 20, y);
    y += 10;
  });
  docPDF.save('report.pdf');
});
</script>

</body>
</html>