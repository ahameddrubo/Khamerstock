<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Khamer Store Management App" data-ar="تطبيق خمر لإدارة المخزون">Khamer Store Management App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa; /* Light grey background */
            color: #343a40; /* Dark grey text */
            line-height: 1.6;
            direction: rtl; /* Default to RTL for Arabic */
            text-align: right; /* Default to right-align for Arabic */
        }
        body.en {
            direction: ltr; /* LTR for English */
            text-align: left; /* Left-align for English */
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header Styles */
        header {
            background-color: #007bff; /* Blue header */
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }
        .app-credit {
            font-size: 0.8em;
            margin-top: 5px;
            color: #d1e7dd; /* Lighter color for credit */
        }

        /* Language Toggle */
        #language-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 1000;
            text-align: center;
        }
        body.en #language-toggle {
            left: 15px;
            right: auto;
        }

        /* Navigation Styles */
        nav {
            display: flex;
            justify-content: center;
            background-color: #343a40; /* Dark grey navigation */
            padding: 15px 0;
            border-radius: 0 0 8px 8px;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        nav button {
            background-color: #6c757d; /* Light grey button */
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px; /* Adjust margin for wrapping */
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        nav button:hover {
            background-color: #5a6268; /* Darker on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        /* Section Styles */
        .content-section {
            padding: 30px;
            border-top: 1px solid #dee2e6; /* Light border */
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .content-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #007bff; /* Blue heading */
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            text-align: center;
        }

        /* Form Styles */
        form {
            background-color: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .input-field, select {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ced4da; /* Light border */
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        body.ar .input-field, body.ar select {
            text-align: right;
            direction: rtl;
        }
        body.en .input-field, body.en select {
            text-align: left;
            direction: ltr;
        }

        /* Button Styles */
        .button-group {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            margin: 5px;
        }

        .button-success {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .button-danger {
            background-color: #dc3545; /* Red */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .button-info {
            background-color: #17a2b8; /* Teal */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }

        /* Order Item Styles */
        .order-item, .user-order-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .order-item:hover, .user-order-item:hover {
            transform: translateY(-3px);
        }

        .order-item h4, .user-order-item h4 {
            color: #007bff;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .order-item ul, .user-order-item ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 10px;
        }
        body.ar .order-item ul, body.ar .user-order-item ul {
            list-style-type: arabic-indic;
            padding-right: 20px;
            padding-left: 0;
        }

        .order-item li, .user-order-item li {
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        /* Product Item Styles for User Panel */
        .product-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .product-item:hover {
            transform: translateY(-3px);
        }

        .product-item h4 {
            color: #007bff;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .product-item p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .product-item .quantity-control {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .product-item .quantity-control button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%; /* Make it round */
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 8px;
        }

        .product-item .quantity-control button:hover {
            background-color: #0056b3;
        }

        .product-item .quantity-control span {
            font-size: 1.5em;
            font-weight: bold;
            color: #343a40;
        }

        /* Low Stock Alert Styles */
        .alert-item {
            border: 2px solid #dc3545; /* Stronger red border */
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fdedee; /* Very light red background */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .alert-item p {
            font-weight: 500;
            color: #dc3545;
        }

        /* Stock and Restock Styles */
        .stock-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .stock-item p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .stock-item input {
            margin-bottom: 10px;
            width: calc(100% - 24px);
        }

        /* Login Form Specific */
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .login-form h2 {
            color: #007bff;
            margin-bottom: 25px;
            font-size: 2em;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Message Area for UI Feedback */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .message-area.error {
            background-color: #fdedee;
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        .message-area.info {
            background-color: #e6f7ff;
            color: #17a2b8;
            border: 1px solid #17a2b8;
        }
        .message-area.success {
            background-color: #e6ffe6;
            color: #28a745;
            border: 1px solid #28a745;
        }

        /* Utility classes for display control */
        .login-form, .admin-dashboard, .user-panel, .product-add-form, .low-stock-alert-section, .total-order-report, .stock-restock-section, .order-return-section {
            display: none; /* Hidden by default */
        }
        .active-section {
            display: block; /* Active section is shown */
        }

        /* Navigation for all pages */
        .global-nav {
            background-color: #495057; /* Darker grey for global nav */
            padding: 10px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .global-nav button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .global-nav button:hover {
            background-color: #5a6268;
        }

        /* Admin Sub-navigation Styling */
        .admin-sub-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .admin-sub-nav button {
            width: 100%;
            padding: 15px 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background-color: #007bff; /* Primary blue */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .admin-sub-nav button.logout-btn {
            background-color: #dc3545; /* Red for logout */
            box-shadow: 0 4px 6px rgba(220, 53, 69, 0.2);
        }

        .admin-sub-nav button:hover {
            background-color: #0056b3; /* Darker blue on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 123, 255, 0.3);
        }

        .admin-sub-nav button.logout-btn:hover {
            background-color: #c82333; /* Darker red on hover */
            box-shadow: 0 6px 10px rgba(220, 53, 69, 0.3);
        }

        /* Order Edit Specific Styles */
        .editable-order-item ul {
            list-style-type: none;
            padding: 0;
        }
        .editable-order-item li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .editable-order-item li:last-child {
            border-bottom: none;
        }
        .editable-order-item .edit-quantity-control {
            display: flex;
            align-items: center;
        }
        .editable-order-item .edit-quantity-control input {
            width: 50px;
            text-align: center;
            margin: 0 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .editable-order-item .edit-quantity-control button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        .editable-order-item .delete-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        body.ar .editable-order-item .delete-item-btn {
             margin-right: 10px;
             margin-left: 0;
        }

        /* Back to Admin Dashboard Button */
        .back-to-admin-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: block; /* Ensures it takes full width or is easily centered */
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .back-to-admin-btn:hover {
            background-color: #5a6268;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 10px;
            }

            header h1 {
                font-size: 2em;
            }

            nav button {
                padding: 8px 15px;
                margin: 5px; /* Adjust margin for wrapping */
            }

            .content-section {
                padding: 20px;
            }

            .content-section h2 {
                font-size: 1.5em;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .admin-sub-nav {
                grid-template-columns: 1fr; /* Stack buttons vertically on small screens */
            }
        }
    </style>
</head>
<body class="ar">
    <div id="language-toggle" data-en="اللغة العربية" data-ar="English">English</div>
    <div class="container">
        <header>
            <h1 data-en="Khamer Store Management App" data-ar="تطبيق خمر لإدارة المخزون">Khamer Store Management App</h1>
            <p class="app-credit" data-en="This system Created by Amdadul" data-ar="تم إنشاء هذا النظام بواسطة امدادول">This system Created by Amdadul</p>
        </header>

        <main>
            <nav id="global-navigation" class="global-nav" style="display: none;">
                <button id="nav-logout-btn" class="button-danger" data-en="Logout" data-ar="تسجيل الخروج">Logout</button>
            </nav>


            <section id="login-section" class="login-form active-section">
                <h2 data-en="Login" data-ar="تسجيل الدخول">تسجيل الدخول</h2>
                <form id="login-form">
                    <input type="email" id="login-email" data-en-placeholder="Email (Admin)" data-ar-placeholder="البريد الإلكتروني (المسؤول)" placeholder="البريد الإلكتروني (المسؤول)" class="input-field">
                    <input type="password" id="login-password" data-en-placeholder="Password (Admin)" data-ar-placeholder="كلمة المرور (المسؤول)" placeholder="كلمة المرور (المسؤول)" class="input-field">
                    <button type="submit" class="button-success" data-en="Admin Login" data-ar="تسجيل دخول المسؤول">تسجيل دخول المسؤول</button>
                </form>
                <div id="login-message-area" class="message-area"></div>

                <div class="button-group" style="margin-top: 30px;">
                    <button type="button" id="kitchen-login-btn" class="button-info" data-en="Kitchen Login" data-ar="تسجيل دخول المطبخ">تسجيل دخول المطبخ</button>
                    <button type="button" id="men-login-btn" class="button-info" data-en="Men's Section Login" data-ar="تسجيل دخول قسم الرجال">تسجيل دخول قسم الرجال</button>
                    <button type="button" id="women-login-btn" class="button-info" data-en="Women's Section Login" data-ar="تسجيل دخول قسم النساء">تسجيل دخول قسم النساء</button>
                </div>
            </section>

            <section id="admin-dashboard-section" class="admin-dashboard content-section">
                <h2 data-en="Admin Control Panel" data-ar="لوحة تحكم المسؤول">لوحة تحكم المسؤول</h2>
                <nav class="admin-sub-nav">
                    <button id="show-pending-orders-btn" data-en="Pending Orders Management" data-ar="إدارة الطلبات المعلقة">إدارة الطلبات المعلقة</button>
                    <button id="add-product-btn" data-en="Add New Product" data-ar="إضافة منتج جديد">إضافة منتج جديد</button>
                    <button id="low-stock-btn" data-en="Inventory Alerts" data-ar="تنبيهات المخزون">تنبيهات المخزون</button>
                    <button id="total-order-report-btn" data-en="Comprehensive Sales Report" data-ar="تقرير المبيعات الشامل">تقرير المبيعات الشامل</button>
                    <button id="stock-restock-btn" data-en="Manage Stock & Replenish" data-ar="إدارة وتجديد المخزون">إدارة وتجديد المخزون</button>
                    <button id="order-return-btn" data-en="Process Returns" data-ar="معالجة الإرجاع">معالجة الإرجاع</button>
                    <button id="admin-logout-btn" class="logout-btn" data-en="Logout" data-ar="تسجيل الخروج">تسجيل الخروج</button>
                </nav>
                <div id="admin-dashboard-content" style="margin-top: 20px;">
                    <h3 data-en="Pending Orders" data-ar="الطلبات المعلقة">الطلبات المعلقة</h3>
                    <div id="pending-orders-list">
                        </div>
                </div>
                <div id="admin-message-area" class="message-area"></div>
            </section>

            <section id="add-product-section" class="product-add-form content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Add New Product" data-ar="إضافة منتج جديد">إضافة منتج جديد</h2>
                <form id="add-product-form">
                    <input type="text" id="product-name-en" data-en-placeholder="Product Name (English)" data-ar-placeholder="اسم المنتج (الإنجليزية)" placeholder="اسم المنتج (الإنجليزية)" class="input-field" required>
                    <input type="text" id="product-name-ar" data-en-placeholder="Product Name (Arabic)" data-ar-placeholder="اسم المنتج (العربية)" placeholder="اسم المنتج (العربية)" class="input-field" required>
                    <input type="number" id="product-quantity" data-en-placeholder="Quantity (Current Stock)" data-ar-placeholder="الكمية (المخزون الحالي)" placeholder="الكمية (المخزون الحالي)" class="input-field" required min="0">
                    <input type="number" id="low-stock-alert-quantity" data-en-placeholder="Low Stock Alert Quantity" data-ar-placeholder="كمية تنبيه المخزون المنخفض" placeholder="كمية تنبيه المخزون المنخفض" class="input-field" required min="0">
                    <select id="product-category" class="input-field" required>
                        <option value="" data-en="Select Category" data-ar="اختر الفئة">اختر الفئة</option>
                        <option value="kitchen" data-en="Kitchen" data-ar="المطبخ">المطبخ</option>
                        <option value="men" data-en="Men's Section" data-ar="قسم الرجال">قسم الرجال</option>
                        <option value="women" data-en="Women's Section" data-ar="قسم النساء">قسم النساء</option>
                    </select>
                    <select id="quantity-type" class="input-field" required>
                        <option value="" data-en="Select Quantity Type" data-ar="اختر نوع الكمية">اختر نوع الكمية</option>
                        <option value="piece" data-en="Piece" data-ar="قطعة">قطعة</option>
                        <option value="kg" data-en="KG" data-ar="كيلوغرام">كيلوغرام</option>
                        <option value="liter" data-en="Liter" data-ar="لتر">لتر</option>
                        <option value="carton" data-en="Carton" data-ar="كرتون">كرتون</option>
                    </select>
                    <button type="submit" class="button-success" style="width: 100%;" data-en="Add Product" data-ar="إضافة منتج">إضافة منتج</button>
                </form>
                <div id="add-product-message-area" class="message-area"></div>
            </section>

            <section id="low-stock-alert-section" class="low-stock-alert-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Inventory Alerts" data-ar="تنبيهات المخزون">تنبيهات المخزون</h2>
                <div id="low-stock-products-list">
                    </div>
                <div id="low-stock-message-area" class="message-area"></div>
            </section>

            <section id="total-order-report-section" class="total-order-report content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Comprehensive Sales Report (Last 3 Months)" data-ar="تقرير المبيعات الشامل (آخر 3 أشهر)">تقرير المبيعات الشامل (آخر 3 أشهر)</h2>
                <div id="report-filters" style="margin-bottom: 20px;">
                    <label for="report-category" style="font-weight: bold; margin-right: 10px;" data-en="Category:" data-ar="الفئة:">الفئة:</label>
                    <select id="report-category" class="input-field" style="width: auto; display: inline-block;">
                        <option value="all" data-en="All" data-ar="الكل">الكل</option>
                        <option value="kitchen" data-en="Kitchen" data-ar="المطبخ">المطبخ</option>
                        <option value="men" data-en="Men's Section" data-ar="قسم الرجال">قسم الرجال</option>
                        <option value="women" data-en="Women's Section" data-ar="قسم النساء">قسم النساء</option>
                    </select>
                    <button id="generate-report-btn" class="button-info" style="margin-left: 10px;" data-en="Show Report" data-ar="عرض التقرير">عرض التقرير</button>
                </div>
                <div id="total-order-report-content">
                    </div>
                <div id="report-message-area" class="message-area"></div>
            </section>

            <section id="stock-restock-section" class="stock-restock-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Manage Stock & Replenish" data-ar="إدارة وتجديد المخزون">إدارة وتجديد المخزون</h2>
                <div id="current-stock-list">
                    </div>
                <div id="stock-message-area" class="message-area"></div>
            </section>

            <section id="order-return-section" class="order-return-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Process Returns" data-ar="معالجة الإرجاع">معالجة الإرجاع</h2>
                <form id="return-product-form">
                    <select id="return-product-select" class="input-field" required>
                        <option value="" data-en="Select Product" data-ar="اختر المنتج">اختر المنتج</option>
                        </select>
                    <input type="number" id="return-quantity" data-en-placeholder="Return Quantity" data-ar-placeholder="كمية الإرجاع" placeholder="كمية الإرجاع" class="input-field" required min="1">
                    <button type="submit" class="button-danger" style="width: 100%;" data-en="Return Product" data-ar="إرجاع المنتج">إرجاع المنتج</button>
                </form>
                <div id="return-message-area" class="message-area"></div>
            </section>

            <section id="user-panel-section" class="user-panel content-section">
                <h2 id="user-panel-title" data-en="User Panel" data-ar="لوحة المستخدم">لوحة المستخدم</h2>
                <button id="user-logout-btn" class="button-danger" style="margin-bottom: 20px;" data-en="Logout" data-ar="تسجيل الخروج">تسجيل الخروج</button>

                <h3 data-en="Products to Order" data-ar="المنتجات للطلب">المنتجات للطلب</h3>
                <div id="product-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    </div>

                <h3 data-en="Your Cart" data-ar="سلتك">سلتك</h3>
                <div id="user-cart-summary" style="margin-bottom: 20px;">
                    </div>
                <button id="place-order-btn" class="button-success" style="width: 100%; margin-top: 10px;" data-en="Place Order" data-ar="تقديم الطلب">تقديم الطلب</button>
                <div id="user-order-message-area" class="message-area"></div>


                <h3 data-en="Your Previous Orders" data-ar="طلباتك السابقة">طلباتك السابقة</h3>
                <div id="user-orders-list">
                    </div>
            </section>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBnvcS8kpOrebq66LzQ2hz5Kvv_z_pu5p4",
            authDomain: "stock-5d278.firebaseapp.com",
            projectId: "stock-5d278",
            storageBucket: "stock-5d278.firebasestorage.app",
            messagingSenderId: "730697386577",
            appId: "1:730697386577:web:8b7ef78adac14ee5990670",
            measurementId: "G-CFNVGX1S4W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const userPanelSection = document.getElementById('user-panel-section');
        const addProductSection = document.getElementById('add-product-section');
        const lowStockAlertSection = document.getElementById('low-stock-alert-section');
        const totalOrderReportSection = document.getElementById('total-order-report-section');
        const stockRestockSection = document.getElementById('stock-restock-section');
        const orderReturnSection = document.getElementById('order-return-section');

        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessageArea = document.getElementById('login-message-area');

        const kitchenLoginBtn = document.getElementById('kitchen-login-btn');
        const menLoginBtn = document.getElementById('men-login-btn');
        const womenLoginBtn = document.getElementById('women-login-btn');

        // Admin Sub-navigation Buttons
        const showPendingOrdersBtn = document.getElementById('show-pending-orders-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const lowStockBtn = document.getElementById('low-stock-btn');
        const totalOrderReportBtn = document.getElementById('total-order-report-btn');
        const stockRestockBtn = document.getElementById('stock-restock-btn');
        const orderReturnBtn = document.getElementById('order-return-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const userLogoutBtn = document.getElementById('user-logout-btn');

        const pendingOrdersList = document.getElementById('pending-orders-list');
        const addProductForm = document.getElementById('add-product-form');
        const addProductMessageArea = document.getElementById('add-product-message-area');
        const lowStockProductsList = document.getElementById('low-stock-products-list');
        const totalOrderReportContent = document.getElementById('total-order-report-content');
        const currentStockList = document.getElementById('current-stock-list');
        const returnProductForm = document.getElementById('return-product-form');
        const returnProductSelect = document.getElementById('return-product-select');

        const productList = document.getElementById('product-list');
        const userCartSummary = document.getElementById('user-cart-summary');
        const userOrdersList = document.getElementById('user-orders-list');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const userPanelTitle = document.getElementById('user-panel-title');
        const userOrderMessageArea = document.getElementById('user-order-message-area');

        const globalNavigation = document.getElementById('global-navigation');
        const navLogoutBtn = document.getElementById('nav-logout-btn'); // Renamed for clarity in global nav

        // All back-to-admin-dashboard buttons
        const backToAdminBtns = document.querySelectorAll('.back-to-admin-btn');


        // --- Global Variables ---
        let currentUserCategory = null;
        let userCart = {};

        // --- Language Management ---
        let currentLanguage = 'ar'; // Default language

        const translations = {
            'en': {
                'Khamer Store Management App': 'Khamer Store Management App',
                'This system Created by Amdadul': 'This system Created by Amdadul',
                'Login': 'Login',
                'Email (Admin)': 'Email (Admin)',
                'Password (Admin)': 'Password (Admin)',
                'Admin Login': 'Admin Login',
                'Kitchen Login': 'Kitchen Login',
                'Men\'s Section Login': 'Men\'s Section Login',
                'Women\'s Section Login': 'Women\'s Section Login',
                'Admin Control Panel': 'Admin Control Panel', // New
                'Pending Orders Management': 'Pending Orders Management', // Changed
                'Add New Product': 'Add New Product', // Changed
                'Inventory Alerts': 'Inventory Alerts', // Changed
                'Comprehensive Sales Report': 'Comprehensive Sales Report', // Changed
                'Manage Stock & Replenish': 'Manage Stock & Replenish', // Changed
                'Process Returns': 'Process Returns', // Changed
                'Logout': 'Logout',
                'Pending Orders': 'Pending Orders',
                'Loading Orders...': 'Loading Orders...',
                'No pending orders.': 'No pending orders.',
                'Department:': 'Department:',
                'Order ID:': 'Order ID:',
                'Order Date:': 'Order Date:',
                'Delivered': 'Delivered',
                'Cancel': 'Cancel',
                'Error loading orders:': 'Error loading orders:',
                'Order successfully delivered and stock updated.': 'Order successfully delivered and stock updated.',
                'Failed to deliver order.': 'Failed to deliver order.',
                'Order successfully cancelled.': 'Order successfully cancelled.',
                'Failed to cancel order.': 'Failed to cancel order.',
                'Product Name (English)': 'Product Name (English)',
                'Product Name (Arabic)': 'Product Name (Arabic)',
                'Quantity (Current Stock)': 'Quantity (Current Stock)',
                'Low Stock Alert Quantity': 'Low Stock Alert Quantity',
                'Select Category': 'Select Category',
                'Kitchen': 'Kitchen',
                'Men\'s Section': 'Men\'s Section',
                'Women\'s Section': 'Women\'s Section',
                'Select Quantity Type': 'Select Quantity Type',
                'Piece': 'Piece',
                'KG': 'KG',
                'Liter': 'Liter',
                'Carton': 'Carton',
                'Add Product': 'Add Product',
                'Please fill all fields correctly.': 'Please fill all fields correctly.',
                'Product already exists in this category.': 'Product already exists in this category.',
                'Product successfully added.': 'Product successfully added.',
                'Failed to add product.': 'Failed to add product.',
                'Loading Inventory Alerts...': 'Loading Inventory Alerts...', // Changed
                'No low stock alerts.': 'No low stock alerts.',
                'Current Stock:': 'Current Stock:',
                'Alert Quantity:': 'Alert Quantity:',
                'Remove Alert (Display Only)': 'Remove Alert (Display Only)',
                'Alert successfully removed (display only).': 'Alert successfully removed (display only).',
                'Error loading inventory alerts:': 'Error loading inventory alerts:', // Changed
                'Comprehensive Sales Report (Last 3 Months)': 'Comprehensive Sales Report (Last 3 Months)', // Changed
                'Category:': 'Category:',
                'All': 'All',
                'Show Report': 'Show Report',
                'Loading Report...': 'Loading Report...',
                'No delivered order reports found.': 'No delivered order reports found.',
                'Order ID:': 'Order ID:',
                'Delivery Date:': 'Delivery Date:',
                'Share/Download PDF': 'Share/Download PDF',
                'Report load successful.': 'Report load successful.',
                'Failed to load report:': 'Failed to load report:',
                'Report content not found.': 'Report content not found.',
                'Generating PDF...': 'Generating PDF...',
                'PDF successfully downloaded.': 'PDF successfully downloaded.',
                'Loading Stock...': 'Loading Stock...',
                'No stock items.': 'No stock items.',
                'Remaining Stock:': 'Remaining Stock:',
                'Re-stock Quantity': 'Re-stock Quantity',
                'Re-stock': 'Re-stock',
                'Failed to load stock:': 'Failed to load stock:',
                'Stock successfully updated.': 'Stock successfully updated.',
                'Failed to re-stock:': 'Failed to re-stock:',
                'Select Product': 'Select Product',
                'No products available': 'No products available',
                'Return Quantity': 'Return Quantity',
                'Return Product': 'Return Product',
                'Please select product and valid quantity.': 'Please select product and valid quantity.',
                'Product being returned...': 'Product being returned...',
                'Cannot return more than current stock.': 'Cannot return more than current stock.',
                'Product successfully returned and stock updated.': 'Product successfully returned and stock updated.',
                'Product not found.': 'Product not found.',
                'Failed to return product:': 'Failed to return product:',
                'User Panel': 'User Panel',
                'Products to Order': 'Products to Order',
                'Loading Products...': 'Loading Products...',
                'No products in this category.': 'No products in this category.',
                'Available:': 'Available:',
                'Your Cart': 'Your Cart',
                'Your cart is empty.': 'Your cart is empty.',
                'Place Order': 'Place Order',
                'Added to cart.': 'Added to cart.',
                'Out of stock, cannot add more.': 'Out of stock, cannot add more.',
                'Removed from cart.': 'Removed from cart.',
                'Your cart is empty.': 'Your cart is empty.',
                'Order being placed...': 'Order being placed...',
                'Sorry, insufficient stock for': 'Sorry, insufficient stock for',
                'Please check your cart.': 'Please check your cart.',
                'Order successfully placed.': 'Order successfully placed.',
                'Failed to place order:': 'Failed to place order:',
                'Your Previous Orders': 'Your Previous Orders',
                'Loading your orders...': 'Loading your orders...',
                'You have no orders.': 'You have no orders.',
                'Status:': 'Status:',
                'Cancel Order': 'Cancel Order',
                'Order cancelled successfully.': 'Order cancelled successfully.',
                'Failed to cancel order:': 'Failed to cancel order:',
                'Problem fetching your data:': 'Problem fetching your data:',
                'Unknown user category. Please log in again.': 'Unknown user category. Please log in again.',
                'Login in progress... please wait.': 'Login in progress... please wait.',
                'Login successful.': 'Login successful.',
                'Login failed:': 'Login failed:',
                'Email and password required.': 'Email and password required.',
                'Form elements not loaded.': 'Form elements not loaded.',
                'Admin setup error:': 'Admin setup error:',
                'Admin user document created. Role set to admin.': 'Admin user document created. Role set to admin.',
                'Logout successful.': 'Logout successful.',
                'Warning:': 'Warning:',
                'is out of stock.': 'is out of stock.',
                'Language Arabic': 'Language Arabic',
                'Order Update': 'Order Update',
                'Update Order': 'Update Order',
                'Order successfully updated.': 'Order successfully updated.',
                'Failed to update order.': 'Failed to update order.',
                'Access Denied. Please log in as Admin.': 'Access Denied. Please log in as Admin.',
                'Access Denied. Please log in as a regular user.': 'Access Denied. Please log in as a regular user.',
                'Back to Admin Dashboard': 'Back to Admin Dashboard', // New
                'Login cancelled.': 'Login cancelled.', // New
                'Wrong password.': 'Wrong password.', // New
                'Insufficient stock for': 'Insufficient stock for' // New, already implicitly translated but good to be explicit
            },
            'ar': {
                'Khamer Store Management App': 'تطبيق خمر لإدارة المخزون',
                'This system Created by Amdadul': 'تم إنشاء هذا النظام بواسطة امدادول',
                'Login': 'تسجيل الدخول',
                'Email (Admin)': 'البريد الإلكتروني (المسؤول)',
                'Password (Admin)': 'كلمة المرور (المسؤول)',
                'Admin Login': 'تسجيل دخول المسؤول',
                'Kitchen Login': 'تسجيل دخول المطبخ',
                'Men\'s Section Login': 'تسجيل دخول قسم الرجال',
                'Women\'s Section Login': 'تسجيل دخول قسم النساء',
                'Admin Control Panel': 'لوحة تحكم المسؤول', // New
                'Pending Orders Management': 'إدارة الطلبات المعلقة', // Changed
                'Add New Product': 'إضافة منتج جديد', // Changed
                'Inventory Alerts': 'تنبيهات المخزون', // Changed
                'Comprehensive Sales Report': 'تقرير المبيعات الشامل', // Changed
                'Manage Stock & Replenish': 'إدارة وتجديد المخزون', // Changed
                'Process Returns': 'معالجة الإرجاع', // Changed
                'Logout': 'تسجيل الخروج',
                'Pending Orders': 'الطلبات المعلقة',
                'Loading Orders...': 'جارٍ تحميل الطلبات...',
                'No pending orders.': 'لا توجد طلبات معلقة.',
                'Department:': 'القسم:',
                'Order ID:': 'رقم الطلب:',
                'Order Date:': 'تاريخ الطلب:',
                'Delivered': 'تم التوصيل',
                'Cancel': 'إلغاء',
                'Error loading orders:': 'خطأ في تحميل الطلبات:',
                'Order successfully delivered and stock updated.': 'تم توصيل الطلب وتحديث المخزون بنجاح.',
                'Failed to deliver order.': 'فشل في توصيل الطلب.',
                'Order successfully cancelled.': 'تم إلغاء الطلب بنجاح.',
                'Failed to cancel order.': 'فشل في إلغاء الطلب.',
                'Product Name (English)': 'اسم المنتج (الإنجليزية)',
                'Product Name (Arabic)': 'اسم المنتج (العربية)',
                'Quantity (Current Stock)': 'الكمية (المخزون الحالي)',
                'Low Stock Alert Quantity': 'كمية تنبيه المخزون المنخفض',
                'Select Category': 'اختر الفئة',
                'Kitchen': 'المطبخ',
                'Men\'s Section': 'قسم الرجال',
                'Women\'s Section': 'قسم النساء',
                'Select Quantity Type': 'اختر نوع الكمية',
                'Piece': 'قطعة',
                'KG': 'كيلوغرام',
                'Liter': 'لتر',
                'Carton': 'كرتون',
                'Add Product': 'إضافة منتج',
                'Please fill all fields correctly.': 'يرجى ملء جميع الحقول بشكل صحيح.',
                'Product already exists in this category.': 'المنتج موجود بالفعل في هذه الفئة.',
                'Product successfully added.': 'تمت إضافة المنتج بنجاح.',
                'Failed to add product.': 'فشل في إضافة المنتج.',
                'Loading Inventory Alerts...': 'جارٍ تحميل تنبيهات المخزون...', // Changed
                'No low stock alerts.': 'لا توجد تنبيهات مخزون منخفض.',
                'Current Stock:': 'المخزون الحالي:',
                'Alert Quantity:': 'كمية التنبيه:',
                'Remove Alert (Display Only)': 'إزالة التنبيه (للعرض فقط)',
                'Alert successfully removed (display only).': 'تمت إزالة التنبيه بنجاح (للعرض فقط).',
                'Error loading inventory alerts:': 'خطأ في تحميل تنبيهات المخزون:', // Changed
                'Comprehensive Sales Report (Last 3 Months)': 'تقرير المبيعات الشامل (آخر 3 أشهر)', // Changed
                'Category:': 'الفئة:',
                'All': 'الكل',
                'Show Report': 'عرض التقرير',
                'Loading Report...': 'جارٍ تحميل التقرير...',
                'No delivered order reports found.': 'لم يتم العثور على تقارير طلبات تم تسليمها.',
                'Order ID:': 'رقم الطلب:',
                'Delivery Date:': 'تاريخ التسليم:',
                'Share/Download PDF': 'مشاركة/تنزيل PDF',
                'Report load successful.': 'تم تحميل التقرير بنجاح.',
                'Failed to load report:': 'فشل في تحميل التقرير:',
                'Report content not found.': 'لم يتم العثور على محتوى التقرير.',
                'Generating PDF...': 'جارٍ إنشاء PDF...',
                'PDF successfully downloaded.': 'تم تنزيل PDF بنجاح.',
                'Loading Stock...': 'جارٍ تحميل المخزون...',
                'No stock items.': 'لا توجد عناصر في المخزون.',
                'Remaining Stock:': 'المخزون المتبقي:',
                'Re-stock Quantity': 'كمية إعادة التخزين',
                'Re-stock': 'إعادة التخزين',
                'Failed to load stock:': 'فشل في تحميل المخزون:',
                'Stock successfully updated.': 'تم تحديث المخزون بنجاح.',
                'Failed to re-stock:': 'فشل في إعادة التخزين:',
                'Select Product': 'اختر المنتج',
                'No products available': 'لا توجد منتجات متاحة',
                'Return Quantity': 'كمية الإرجاع',
                'Return Product': 'إرجاع المنتج',
                'Please select product and valid quantity.': 'الرجاء تحديد المنتج وكمية صالحة.',
                'Product being returned...': 'جارٍ إرجاع المنتج...',
                'Cannot return more than current stock.': 'لا يمكن إرجاع كمية أكبر من المخزون الحالي.',
                'Product successfully returned and stock updated.': 'تم إرجاع المنتج بنجاح وتحديث المخزون.',
                'Product not found.': 'لم يتم العثور على المنتج.',
                'Failed to return product:': 'فشل في إرجاع المنتج:',
                'User Panel': 'لوحة المستخدم',
                'Products to Order': 'المنتجات للطلب',
                'Loading Products...': 'جارٍ تحميل المنتجات...',
                'No products in this category.': 'لا توجد منتجات في هذه الفئة.',
                'Available:': 'متاح:',
                'Your Cart': 'سلتك',
                'Your cart is empty.': 'سلتك فارغة.',
                'Place Order': 'تقديم الطلب',
                'Added to cart.': 'تمت الإضافة إلى السلة.',
                'Out of stock, cannot add more.': 'المخزون غير كافٍ، لا يمكن إضافة المزيد.',
                'Removed from cart.': 'تمت الإزالة من السلة.',
                'Your cart is empty.': 'سلتك فارغة.',
                'Order being placed...': 'جارٍ تقديم الطلب...',
                'Sorry, insufficient stock for': 'عذرًا، المخزون غير كافٍ لـ',
                'Please check your cart.': 'يرجى مراجعة سلتك.',
                'Order successfully placed.': 'تم تقديم الطلب بنجاح.',
                'Failed to place order:': 'فشل في تقديم الطلب:',
                'Your Previous Orders': 'طلباتك السابقة',
                'Loading your orders...': 'جارٍ تحميل طلباتك...',
                'You have no orders.': 'ليس لديك طلبات.',
                'Status:': 'الحالة:',
                'Cancel Order': 'إلغاء الطلب',
                'Order cancelled successfully.': 'تم إلغاء الطلب بنجاح.',
                'Failed to cancel order:': 'فشل في إلغاء الطلب:',
                'Problem fetching your data:': 'مشكلة في جلب بياناتك:',
                'Unknown user category. Please log in again.': 'فئة مستخدم غير معروفة. يرجى تسجيل الدخول مرة أخرى.',
                'Login in progress... please wait.': 'جارٍ تسجيل الدخول... يرجى الانتظار.',
                'Login successful.': 'تم تسجيل الدخول بنجاح.',
                'Login failed:': 'فشل تسجيل الدخول:',
                'Email and password required.': 'البريد الإلكتروني وكلمة المرور مطلوبان.',
                'Form elements not loaded.': 'لم يتم تحميل عناصر النموذج.',
                'Admin setup error:': 'خطأ في إعداد المسؤول:',
                'Admin user document created. Role set to admin.': 'تم إنشاء مستند مستخدم المسؤول. تم تعيين الدور للمسؤول.',
                'Logout successful.': 'تم تسجيل الخروج بنجاح.',
                'Warning:': 'تحذير:',
                'is out of stock.': 'نفد المخزون.',
                'Language Arabic': 'اللغة العربية',
                'Order Update': 'تحديث الطلب',
                'Update Order': 'تحديث الطلب',
                'Order successfully updated.': 'تم تحديث الطلب بنجاح.',
                'Failed to update order.': 'فشل في تحديث الطلب.',
                'Access Denied. Please log in as Admin.': 'الوصول مرفوض. يرجى تسجيل الدخول كمسؤول.',
                'Access Denied. Please log in as a regular user.': 'الوصول مرفوض. يرجى تسجيل الدخول كمستخدم عادي.',
                'Back to Admin Dashboard': 'العودة للوحة تحكم المسؤول', // New
                'Login cancelled.': 'تم إلغاء تسجيل الدخول.', // New
                'Wrong password.': 'كلمة مرور خاطئة.', // New
                'Insufficient stock for': 'المخزون غير كافٍ لـ' // New
            }
        };

        const translatableElements = document.querySelectorAll('[data-en], [data-ar-placeholder]');

        function setLanguage(lang) {
            currentLanguage = lang;
            document.body.className = lang; // Set class for RTL/LTR and font-family
            document.querySelector('html').lang = lang; // Set HTML lang attribute

            translatableElements.forEach(el => {
                const enText = el.dataset.en;
                const arText = el.dataset.ar;
                const enPlaceholder = el.dataset.enPlaceholder;
                const arPlaceholder = el.dataset.arPlaceholder;

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (lang === 'en' && enPlaceholder) {
                        el.placeholder = enPlaceholder;
                    } else if (lang === 'ar' && arPlaceholder) {
                        el.placeholder = arPlaceholder;
                    }
                } else if (enText && arText) {
                    el.textContent = lang === 'en' ? enText : arText;
                }
            });
            // Update selected option texts if needed (for select elements)
            document.querySelectorAll('select option').forEach(option => {
                // Check for data-en and data-ar attributes on options if they exist
                const optionEnText = option.dataset.en;
                const optionArText = option.dataset.ar;

                if (optionEnText && optionArText) {
                    option.textContent = lang === 'en' ? optionEnText : optionArText;
                } else {
                    // Fallback to direct translation for common values if data attributes are not consistently set
                    if (option.value === "") {
                        option.textContent = lang === 'en' ? translations.en['Select Category'] : translations.ar['اختر الفئة'];
                    } else if (option.value === "kitchen") {
                        option.textContent = lang === 'en' ? translations.en['Kitchen'] : translations.ar['المطبخ'];
                    } else if (option.value === "men") {
                        option.textContent = lang === 'en' ? translations.en['Men\'s Section'] : translations.ar['قسم الرجال'];
                    } else if (option.value === "women") {
                        option.textContent = lang === 'en' ? translations.en['Women\'s Section'] : translations.ar['قسم النساء'];
                    } else if (option.value === "piece") {
                        option.textContent = lang === 'en' ? translations.en['Piece'] : translations.ar['قطعة'];
                    } else if (option.value === "kg") {
                        option.textContent = lang === 'en' ? translations.en['KG'] : translations.ar['كيلوغرام'];
                    } else if (option.value === "liter") {
                        option.textContent = lang === 'en' ? translations.en['Liter'] : translations.ar['لتر'];
                    } else if (option.value === "carton") {
                        option.textContent = lang === 'en' ? translations.en['Carton'] : translations.ar['كرتون'];
                    }
                }
            });

            // Update specific dynamic texts like user panel title and restock input placeholder
            if (currentUserCategory) {
                userPanelTitle.textContent = translations[currentLanguage]['User Panel'];
            }
            document.querySelectorAll('.restock-quantity').forEach(input => {
                input.placeholder = currentLanguage === 'en' ? translations.en['Re-stock Quantity'] : translations.ar['كمية إعادة التخزين'];
            });
        }

        // Language toggle button
        const languageToggleButton = document.getElementById('language-toggle');
        if (languageToggleButton) {
            languageToggleButton.addEventListener('click', () => {
                const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
                setLanguage(newLang);
                localStorage.setItem('appLang', newLang); // Save preference
                languageToggleButton.textContent = newLang === 'ar' ? languageToggleButton.dataset.ar : languageToggleButton.dataset.en;
            });
        }
        // Load language preference from localStorage
        const savedLang = localStorage.getItem('appLang');
        if (savedLang) {
            setLanguage(savedLang);
            languageToggleButton.textContent = savedLang === 'ar' ? languageToggleButton.dataset.ar : languageToggleButton.dataset.en;
        } else {
            setLanguage('ar'); // Default to Arabic
        }


        // --- Utility Functions ---

        // Function: Display Messages in UI
        function displayMessage(areaElement, messageKey, type) {
            if (!areaElement) {
                console.error("Message area element not found:", areaElement);
                return;
            }
            const message = translations[currentLanguage][messageKey] || messageKey; // Translate if key exists
            areaElement.textContent = message;
            areaElement.className = `message-area ${type}`;
            areaElement.style.display = 'block';
            setTimeout(() => {
                areaElement.style.display = 'none';
                areaElement.textContent = '';
            }, 5000);
        }

        // Function: Hide and Show Sections with History Management
        function showSection(sectionToShow, state = null) {
            console.log("Attempting to show section:", sectionToShow ? sectionToShow.id : "null", "with state:", state);
            const sections = [
                loginSection, adminDashboardSection, userPanelSection, addProductSection,
                lowStockAlertSection, totalOrderReportSection, stockRestockSection, orderReturnSection
            ];
            sections.forEach(section => {
                if (section) section.classList.remove('active-section');
            });

            if (sectionToShow) {
                sectionToShow.classList.add('active-section');

                // Update global navigation visibility
                if (sectionToShow === loginSection) {
                    globalNavigation.style.display = 'none';
                } else {
                    globalNavigation.style.display = 'flex';
                }

                // Manage browser history for back button functionality
                const sectionId = sectionToShow.id;
                if (history.state && history.state.sectionId === sectionId) {
                    // Do nothing if already on this state to avoid duplicate history entries
                } else {
                    history.pushState({ sectionId: sectionId, category: currentUserCategory }, '', `#${sectionId}`);
                }
            } else {
                console.error("Section to show is null:", sectionToShow);
            }
        }

        // Handle browser's back/forward button
        window.addEventListener('popstate', (event) => {
            console.log("Popstate event triggered. State:", event.state);
            if (event.state && event.state.sectionId) {
                const targetSection = document.getElementById(event.state.sectionId);
                if (targetSection) {
                    // Directly show the section without pushing another history state
                    const sections = [
                        loginSection, adminDashboardSection, userPanelSection, addProductSection,
                        lowStockAlertSection, totalOrderReportSection, stockRestockSection, orderReturnSection
                    ];
                    sections.forEach(section => {
                        if (section) section.classList.remove('active-section');
                    });
                    targetSection.classList.add('active-section');

                    // Re-run data loading for the section if necessary
                    if (targetSection === adminDashboardSection) {
                        loadAdminDashboard();
                    } else if (targetSection === addProductSection) {
                        // Nothing specific needed here, form is static
                    } else if (targetSection === lowStockAlertSection) {
                        loadLowStockAlerts();
                    } else if (targetSection === totalOrderReportSection) {
                        loadTotalOrderReport(); // Reload with default 'all' category
                    } else if (targetSection === stockRestockSection) {
                        loadStockAndRestock();
                    } else if (targetSection === orderReturnSection) {
                        loadOrderReturnProducts();
                    } else if (targetSection === userPanelSection && event.state.category) {
                         currentUserCategory = event.state.category; // Restore category
                         loadUserProducts(currentUserCategory);
                         loadUserOrders(auth.currentUser.uid);
                         updateCartSummary();
                    }
                     // Update global navigation visibility
                    if (targetSection === loginSection) {
                        globalNavigation.style.display = 'none';
                    } else {
                        globalNavigation.style.display = 'flex';
                    }
                }
            } else {
                // If no state, go back to login or default
                showSection(loginSection);
            }
        });


        // --- Firebase Collection Initialization ---
        async function initializeFirebaseCollections() {
            console.log("Checking Firebase collections for initialization...");
            const collections = ['products', 'orders', 'stock', 'returns', 'users'];
            for (const collectionName of collections) {
                try {
                    // Attempt to get a dummy doc to see if collection exists
                    const docRef = db.collection(collectionName).doc('__dummy_init__');
                    await docRef.get(); // Just try to read, doesn't need to exist
                    console.log(`Collection '${collectionName}' already seems to exist.`);
                } catch (error) {
                    if (error.code === 'not-found' || error.code === 'permission-denied') {
                        // If 'not-found' or 'permission-denied' (implying collection not there for current user),
                        // or other errors that mean it's not initialized, then create a dummy doc and delete
                        try {
                            const initDocRef = db.collection(collectionName).doc('__init__');
                            await initDocRef.set({ initialized: true });
                            await initDocRef.delete();
                            console.log(`Collection '${collectionName}' initialized successfully.`);
                        } catch (initError) {
                            console.warn(`Error during explicit initialization for '${collectionName}':`, initError.message);
                        }
                    } else {
                        console.warn(`Unexpected error checking collection '${collectionName}':`, error.message);
                    }
                }
            }
        }

        // --- Auth State Change Handler ---
        auth.onAuthStateChanged(async (user) => {
            console.log("Firebase Auth State Changed. Current user:", user ? user.uid : "None");
            if (user) {
                const userDocRef = db.collection('users').doc(user.uid);
                let userDoc;
                try {
                    userDoc = await userDocRef.get();
                } catch (error) {
                    console.error("Error fetching user document from Firestore:", error);
                    displayMessage(loginMessageArea, 'Problem fetching your data:', 'error');
                    auth.signOut();
                    return;
                }

                if (userDoc.exists) {
                    currentUserCategory = userDoc.data().role;
                    console.log(`User ${user.email || user.uid} logged in. Role: ${currentUserCategory}`);

                    if (currentUserCategory === 'admin') {
                        showSection(adminDashboardSection);
                        renderAdminDashboard(); // Call a function to show the default dashboard view
                    } else {
                        showSection(userPanelSection);
                        userPanelTitle.textContent = translations[currentLanguage]['User Panel']; // Update title based on language
                        loadUserProducts(currentUserCategory);
                        loadUserOrders(user.uid);
                        updateCartSummary();
                    }
                } else {
                    console.log(`User document for ${user.uid} not found. Attempting to create it.`);
                    // Only create a document for non-anonymous users on first login
                    if (!user.isAnonymous) {
                        try {
                            await userDocRef.set({
                                role: 'admin', // Default to admin if no doc exists for email login
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            currentUserCategory = 'admin';
                            console.log(`Admin user document created for ${user.email}. Role set to 'admin'.`);
                            displayMessage(loginMessageArea, 'Admin user document created. Role set to admin.', 'success');
                            showSection(adminDashboardSection);
                            renderAdminDashboard();
                        } catch (error) {
                            console.error("Error creating admin user document on first login:", error);
                            displayMessage(loginMessageArea, 'Admin setup error:', 'error');
                            auth.signOut();
                        }
                    } else {
                        console.warn("Anonymous user logged in but no role document found. Logging out.");
                        displayMessage(loginMessageArea, 'Unknown user category. Please log in again.', 'error');
                        auth.signOut();
                    }
                }
            } else {
                console.log("No user logged in. Showing login section.");
                showSection(loginSection);
                currentUserCategory = null;
                userCart = {};
                updateCartSummary();
                if (loginEmailInput) loginEmailInput.value = '';
                if (loginPasswordInput) loginPasswordInput.value = '';
                // Clear history state when logging out
                history.replaceState(null, '', '#login');
            }
        });

        // --- Login Handlers ---
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Admin login button clicked.");

                if (!loginEmailInput || !loginPasswordInput) {
                    console.error("Login input elements not found in DOM!");
                    displayMessage(loginMessageArea, 'Form elements not loaded.', 'error');
                    return;
                }

                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value;

                if (!email || !password) {
                    displayMessage(loginMessageArea, 'Email and password required.', 'error');
                    return;
                }

                console.log("Attempting admin login with email:", email);
                displayMessage(loginMessageArea, 'Login in progress... please wait.', 'info');

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    console.log("Firebase Auth successful! UID:", userCredential.user.uid);
                    // The auth.onAuthStateChanged listener will handle redirection
                    displayMessage(loginMessageArea, 'Login successful.', 'success');
                } catch (error) {
                    console.error("Firebase Login Error:", error);
                    displayMessage(loginMessageArea, `Login failed: ${error.message}`, 'error');
                }
            });
        }

        // Anonymous Login Handler
        async function handleAnonymousLogin(category, expectedPassword) {
            const password = prompt(translations[currentLanguage][`${category} Login`]); // Prompt in chosen language
            if (password === null) {
                displayMessage(loginMessageArea, 'Login cancelled.', 'info');
                return;
            }
            if (password === expectedPassword) {
                console.log(`Attempting anonymous login for category: ${category}`);
                displayMessage(loginMessageArea, 'Login in progress... please wait.', 'info');
                try {
                    const userCredential = await auth.signInAnonymously();
                    const user = userCredential.user;
                    console.log("Anonymous Auth successful! UID:", user.uid);

                    const userDocRef = db.collection('users').doc(user.uid);
                    await userDocRef.set({
                        role: category,
                        email: 'anonymous', // Store 'anonymous' as email for identification
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`Anonymous user role '${category}' set in Firestore.`);
                } catch (error) {
                    console.error("Anonymous login error:", error);
                    displayMessage(loginMessageArea, `Login failed: ${error.message}`, 'error');
                }
            } else {
                displayMessage(loginMessageArea, 'Wrong password.', 'error');
            }
        }

        if (kitchenLoginBtn) kitchenLoginBtn.addEventListener('click', () => handleAnonymousLogin('kitchen', 'KhamerK'));
        if (menLoginBtn) menLoginBtn.addEventListener('click', () => handleAnonymousLogin('men', 'KhamerM'));
        if (womenLoginBtn) womenLoginBtn.addEventListener('click', () => handleAnonymousLogin('women', 'KhamerF'));

        // --- Logout Handlers ---
        async function handleLogout() {
            console.log("Logout button clicked.");
            await auth.signOut();
            displayMessage(loginMessageArea, 'Logout successful.', 'success');
            // auth.onAuthStateChanged will handle showing login section
        }
        if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleLogout);
        if (userLogoutBtn) userLogoutBtn.addEventListener('click', handleLogout);
        if (navLogoutBtn) navLogoutBtn.addEventListener('click', handleLogout); // Global logout

        // --- Admin Panel Functionality ---

        // Function to render the main admin dashboard content (pending orders)
        function renderAdminDashboard() {
            loadAdminDashboard(); // This loads pending orders
            // Ensure the pending orders content div is visible
            document.getElementById('admin-dashboard-content').style.display = 'block';
        }

        // Load Dashboard (Pending Orders)
        async function loadAdminDashboard() {
            console.log("Loading admin dashboard (pending orders)...");
            pendingOrdersList.innerHTML = `<p>${translations[currentLanguage]['Loading Orders...']}</p>`;
            db.collection('orders').where('status', '==', 'pending').orderBy('orderDate', 'desc')
                .onSnapshot(snapshot => {
                    pendingOrdersList.innerHTML = '';
                    if (snapshot.empty) {
                        pendingOrdersList.innerHTML = `<p>${translations[currentLanguage]['No pending orders.']}</p>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id; // Still needed internally for operations
                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.classList.add('order-item');
                        orderItemDiv.innerHTML = `
                            <h4>${translations[currentLanguage]['Department:']} ${order.category.charAt(0).toUpperCase() + order.category.slice(1)}</h4>
                            <p><strong>${translations[currentLanguage]['Order Date:']}</strong> ${order.orderDate.toDate().toLocaleString()}</p>
                            <ul>
                                ${Object.keys(order.products).map(productId => `
                                    <li>${currentLanguage === 'en' ? order.products[productId].name_en : order.products[productId].name_ar}: <strong>${order.products[productId].quantity}</strong> ${order.products[productId].type}</li>
                                `).join('')}
                            </ul>
                            <button class="button-success deliver-order-btn" data-order-id="${orderId}">${translations[currentLanguage]['Delivered']}</button>
                            <button class="button-danger cancel-order-btn" data-order-id="${orderId}" style="margin-left: 10px;">${translations[currentLanguage]['Cancel']}</button>
                        `;
                        pendingOrdersList.appendChild(orderItemDiv);
                    });

                    document.querySelectorAll('.deliver-order-btn').forEach(button => {
                        button.addEventListener('click', handleDeliverOrder);
                    });
                    document.querySelectorAll('.cancel-order-btn').forEach(button => {
                        button.addEventListener('click', handleCancelOrder);
                    });
                }, error => {
                    console.error("Error loading pending orders:", error);
                    displayMessage(document.getElementById('admin-message-area'), `${translations[currentLanguage]['Error loading orders:']} ${error.message}`, 'error');
                });
        }

        // Order Delivered Handler
        async function handleDeliverOrder(event) {
            const orderId = event.target.dataset.orderId;
            const orderRef = db.collection('orders').doc(orderId);
            const confirmDelivery = confirm(currentLanguage === 'en' ? "Are you sure you want to mark this order as delivered and update stock?" : "هل أنت متأكد أنك تريد وضع علامة على هذا الطلب كمُسلم وتحديث المخزون؟");
            if (!confirmDelivery) return;

            console.log("Handling deliver order for ID:", orderId);
            displayMessage(document.getElementById('admin-message-area'), 'Order being delivered...', 'info');

            try {
                const orderDoc = await orderRef.get();
                if (orderDoc.exists) {
                    const order = orderDoc.data();
                    const batch = db.batch();

                    for (const productId in order.products) {
                        const productOrder = order.products[productId];
                        const productRef = db.collection('stock').doc(productId);
                        const stockDoc = await productRef.get();
                        if (stockDoc.exists) {
                            batch.update(productRef, {
                                quantity: firebase.firestore.FieldValue.increment(-productOrder.quantity)
                            });
                        } else {
                            console.warn(`Product ${productId} not found in stock. Skipping stock update for this item.`);
                            displayMessage(document.getElementById('admin-message-area'), `${translations[currentLanguage]['Warning:']} ${currentLanguage === 'en' ? productOrder.name_en : productOrder.name_ar} ${translations[currentLanguage]['is out of stock.']}`, 'info');
                        }
                    }

                    batch.update(orderRef, { status: 'delivered', deliveredAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await batch.commit();
                    displayMessage(document.getElementById('admin-message-area'), 'Order successfully delivered and stock updated.', 'success');
                }
            } catch (error) {
                console.error("Error delivering order:", error);
                displayMessage(document.getElementById('admin-message-area'), `${translations[currentLanguage]['Failed to deliver order:']} ${error.message}`, 'error');
            }
        }

        // Order Cancel Handler (Admin Panel)
        async function handleCancelOrder(event) {
            const orderId = event.target.dataset.orderId;
            const confirmCancel = confirm(currentLanguage === 'en' ? "Are you sure you want to cancel this order?" : "هل أنت متأكد أنك تريد إلغاء هذا الطلب؟");
            if (!confirmCancel) return;

            console.log("Handling cancel order for ID:", orderId);
            displayMessage(document.getElementById('admin-message-area'), 'Order being cancelled...', 'info');

            try {
                await db.collection('orders').doc(orderId).update({
                    status: 'cancelled',
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                displayMessage(document.getElementById('admin-message-area'), 'Order successfully cancelled.', 'success');
            } catch (error) {
                console.error("Error canceling order:", error);
                displayMessage(document.getElementById('admin-message-area'), `${translations[currentLanguage]['Failed to cancel order:']} ${error.message}`, 'error');
            }
        }

        // Add Product
        if (addProductForm) {
            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Add product form submitted.");

                const nameEn = document.getElementById('product-name-en').value.trim();
                const nameAr = document.getElementById('product-name-ar').value.trim();
                const quantity = parseInt(document.getElementById('product-quantity').value);
                const lowStockAlertQuantity = parseInt(document.getElementById('low-stock-alert-quantity').value);
                const category = document.getElementById('product-category').value;
                const quantityType = document.getElementById('quantity-type').value;

                if (!nameEn || !nameAr || isNaN(quantity) || quantity < 0 || isNaN(lowStockAlertQuantity) || lowStockAlertQuantity < 0 || !category || !quantityType) {
                    displayMessage(addProductMessageArea, 'Please fill all fields correctly.', 'error');
                    return;
                }

                displayMessage(addProductMessageArea, 'Product being added...', 'info');

                try {
                    const existingProductSnapshot = await db.collection('products')
                                                    .where('name_en', '==', nameEn)
                                                    .where('category', '==', category)
                                                    .limit(1).get();

                    if (!existingProductSnapshot.empty) {
                        displayMessage(addProductMessageArea, 'Product already exists in this category.', 'error');
                        return;
                    }

                    const newProductRef = db.collection('products').doc();
                    await newProductRef.set({
                        name_en: nameEn,
                        name_ar: nameAr,
                        category: category,
                        quantity_type: quantityType,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    await db.collection('stock').doc(newProductRef.id).set({
                        productId: newProductRef.id,
                        name_en: nameEn,
                        name_ar: nameAr,
                        quantity: quantity,
                        lowStockAlert: lowStockAlertQuantity,
                        category: category,
                        quantity_type: quantityType,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    displayMessage(addProductMessageArea, 'Product successfully added.', 'success');
                    addProductForm.reset();
                } catch (error) {
                    console.error("Error adding product:", error);
                    displayMessage(addProductMessageArea, `Failed to add product: ${error.message}`, 'error');
                }
            });
        }

        // Load Low-Stock Alerts
        async function loadLowStockAlerts() {
            console.log("Loading low stock alerts...");
            lowStockProductsList.innerHTML = `<p>${translations[currentLanguage]['Loading Inventory Alerts...']}</p>`;
            db.collection('stock').onSnapshot(snapshot => {
                lowStockProductsList.innerHTML = '';
                let hasLowStock = false;
                snapshot.forEach(doc => {
                    const product = doc.data();
                    if (product.quantity <= product.lowStockAlert && product.quantity > 0) {
                        hasLowStock = true;
                        const alertItemDiv = document.createElement('div');
                        alertItemDiv.classList.add('alert-item');
                        alertItemDiv.innerHTML = `
                            <p><strong>${currentLanguage === 'en' ? product.name_en : product.name_ar}</strong></p>
                            <p>${translations[currentLanguage]['Current Stock:']} ${product.quantity} ${product.quantity_type}</p>
                            <p>${translations[currentLanguage]['Alert Quantity:']} ${product.lowStockAlert}</p>
                            <button class="button-info remove-alert-btn" data-product-id="${doc.id}">${translations[currentLanguage]['Remove Alert (Display Only)']}</button>
                        `;
                        lowStockProductsList.appendChild(alertItemDiv);
                    }
                });
                if (!hasLowStock) {
                    lowStockProductsList.innerHTML = `<p>${translations[currentLanguage]['No low stock alerts.']}</p>`;
                }
            }, error => {
                console.error("Error loading low stock alerts:", error);
                displayMessage(document.getElementById('low-stock-message-area'), `${translations[currentLanguage]['Error loading inventory alerts:']} ${error.message}`, 'error');
            });
        }

        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-alert-btn')) {
                console.log("Remove alert button clicked.");
                e.target.closest('.alert-item').remove();
                displayMessage(document.getElementById('low-stock-message-area'), 'Alert successfully removed (display only).', 'success');
            }
        });

        // Load Total Order Report
        async function loadTotalOrderReport(category = 'all') {
            console.log("Loading total order report for category:", category);
            totalOrderReportContent.innerHTML = `<p>${translations[currentLanguage]['Loading Report...']}</p>`;
            displayMessage(document.getElementById('report-message-area'), 'Loading Report...', 'info');

            const today = new Date();
            let startDate = new Date(today.getFullYear(), today.getMonth() - 2, 20);

            let query = db.collection('orders').where('status', '==', 'delivered').where('deliveredAt', '>=', startDate);

            if (category !== 'all') {
                query = query.where('category', '==', category);
            }

            try {
                const snapshot = await query.orderBy('deliveredAt', 'desc').get();
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });

                if (orders.length === 0) {
                    totalOrderReportContent.innerHTML = `<p>${translations[currentLanguage]['No delivered order reports found.']}</p>`;
                    displayMessage(document.getElementById('report-message-area'), 'No delivered order reports found.', 'info');
                    return;
                }

                const groupedOrders = {};
                orders.forEach(order => {
                    if (order.deliveredAt) {
                        const deliveredDate = order.deliveredAt.toDate();
                        const year = deliveredDate.getFullYear();
                        let month = deliveredDate.getMonth();
                        const day = deliveredDate.getDate();

                        let reportMonthKey;
                        // Logic for reporting period (20th to 19th of next month)
                        if (day >= 20) {
                            let nextMonth = month + 1;
                            let nextYear = year;
                            if (nextMonth > 11) { nextMonth = 0; nextYear++; } // January is 0, so nextMonth 12 becomes 0 (Jan)
                            reportMonthKey = `${nextYear}-${(nextMonth + 1).toString().padStart(2, '0')}`;
                        } else {
                            // If before 20th, it belongs to the previous reporting month
                            let prevMonth = month; // Current month (0-11)
                            let prevYear = year;
                            reportMonthKey = `${prevYear}-${(prevMonth + 1).toString().padStart(2, '0')}`; // Use current month for reporting
                        }

                        if (!groupedOrders[reportMonthKey]) {
                            groupedOrders[reportMonthKey] = [];
                        }
                        groupedOrders[reportMonthKey].push(order);
                    }
                });

                let reportHtml = '';
                // Sort month keys correctly (e.g., "2024-11", "2024-12", "2025-01")
                const sortedMonthKeys = Object.keys(groupedOrders).sort();

                if (sortedMonthKeys.length === 0) {
                    totalOrderReportContent.innerHTML = `<p>${translations[currentLanguage]['No delivered order reports found.']}</p>`;
                    displayMessage(document.getElementById('report-message-area'), 'No delivered order reports found.', 'info');
                    return;
                }

                sortedMonthKeys.forEach(monthKey => {
                    reportHtml += `<div class="report-section" id="report-section-${monthKey.replace('-', '_')}">`;
                    reportHtml += `<h3>${monthKey}</h3>`;
                    reportHtml += `<ul>`;
                    groupedOrders[monthKey].forEach(order => {
                        reportHtml += `
                            <li>
                                <p><strong>${translations[currentLanguage]['Order ID:']}</strong> ${order.id}</p>
                                <p><strong>${translations[currentLanguage]['Department:']}</strong> ${order.category.charAt(0).toUpperCase() + order.category.slice(1)}</p>
                                <p><strong>${translations[currentLanguage]['Delivery Date:']}</strong> ${order.deliveredAt.toDate().toLocaleString()}</p>
                                <ul>
                                    ${Object.keys(order.products).map(productId => `
                                        <li>${currentLanguage === 'en' ? order.products[productId].name_en : order.products[productId].name_ar}: <strong>${order.products[productId].quantity}</strong> ${order.products[productId].type}</li>
                                    `).join('')}
                                </ul>
                            </li>
                        `;
                    });
                    reportHtml += `</ul>`;
                    reportHtml += `<button class="button-info share-report-btn" data-month-key="${monthKey}">${translations[currentLanguage]['Share/Download PDF']}</button><hr>`;
                    reportHtml += `</div>`;
                });
                totalOrderReportContent.innerHTML = reportHtml;
                displayMessage(document.getElementById('report-message-area'), 'Report load successful.', 'success');

                document.querySelectorAll('.share-report-btn').forEach(button => {
                    button.addEventListener('click', handleShareReport);
                });

            } catch (error) {
                console.error("Error loading total order report:", error);
                displayMessage(document.getElementById('report-message-area'), `${translations[currentLanguage]['Failed to load report:']} ${error.message}`, 'error');
            }
        }

        // Share/Download PDF Report
        async function handleShareReport(event) {
            const monthKey = event.target.dataset.monthKey;
            const reportElement = document.getElementById(`report-section-${monthKey.replace('-', '_')}`);

            if (!reportElement) {
                displayMessage(document.getElementById('report-message-area'), 'Report content not found.', 'error');
                return;
            }

            console.log("Generating PDF for report section:", monthKey);
            displayMessage(document.getElementById('report-message-area'), 'Generating PDF...', 'info');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const clonedReport = reportElement.cloneNode(true);
            clonedReport.querySelectorAll('button').forEach(btn => btn.remove()); // Remove buttons from cloned content
            clonedReport.querySelector('hr').remove(); // Remove hr from cloned content

            // Set font for Arabic characters if needed, this is a basic example
            // For full Arabic support, you might need a custom font loaded into jsPDF
            // doc.setFont('Amiri-Regular'); // Example for a font like Amiri, must be loaded first
            // doc.addFont('Amiri-Regular.ttf', 'Amiri-Regular', 'normal');

            doc.html(clonedReport.outerHTML, {
                callback: function (doc) {
                    doc.save(`Order_Report_${monthKey}.pdf`);
                    displayMessage(document.getElementById('report-message-area'), 'PDF successfully downloaded.', 'success');
                },
                x: 10,
                y: 10,
                width: 190,
                windowWidth: clonedReport.scrollWidth || 700 // Estimate content width
            });
        }

        // Load Stock and Restock
        async function loadStockAndRestock() {
            console.log("Loading stock and restock section...");
            currentStockList.innerHTML = `<p>${translations[currentLanguage]['Loading Stock...']}</p>`;
            db.collection('stock').onSnapshot(snapshot => {
                currentStockList.innerHTML = '';
                if (snapshot.empty) {
                    currentStockList.innerHTML = `<p>${translations[currentLanguage]['No stock items.']}</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const stockItemDiv = document.createElement('div');
                    stockItemDiv.classList.add('stock-item');
                    stockItemDiv.innerHTML = `
                        <p><strong>${currentLanguage === 'en' ? product.name_en : product.name_ar}</strong> - ${translations[currentLanguage]['Remaining Stock:']} <strong>${product.quantity}</strong> ${product.quantity_type}</p>
                        <input type="number" class="input-field restock-quantity" data-en-placeholder="Re-stock Quantity" data-ar-placeholder="كمية إعادة التخزين" placeholder="${currentLanguage === 'en' ? translations.en['Re-stock Quantity'] : translations.ar['كمية إعادة التخزين']}" data-product-id="${doc.id}" min="1">
                        <button class="button-info restock-btn" data-product-id="${doc.id}">${translations[currentLanguage]['Re-stock']}</button>
                    `;
                    currentStockList.appendChild(stockItemDiv);
                     // Update placeholder text dynamically
                    const restockInput = stockItemDiv.querySelector('.restock-quantity');
                    if (restockInput) {
                        restockInput.placeholder = currentLanguage === 'en' ? translations.en['Re-stock Quantity'] : translations.ar['كمية إعادة التخزين'];
                    }
                });

                document.querySelectorAll('.restock-btn').forEach(button => {
                    button.addEventListener('click', handleRestock);
                });
            }, error => {
                console.error("Error loading stock:", error);
                displayMessage(document.getElementById('stock-message-area'), `${translations[currentLanguage]['Failed to load stock:']} ${error.message}`, 'error');
            });
        }

        // Restock Handler
        async function handleRestock(event) {
            const productId = event.target.dataset.productId;
            const quantityInput = event.target.previousElementSibling;
            const restockQuantity = parseInt(quantityInput.value);

            if (isNaN(restockQuantity) || restockQuantity <= 0) {
                displayMessage(document.getElementById('stock-message-area'), 'Please enter a valid quantity.', 'error');
                return;
            }

            console.log(`Restocking product ${productId} with quantity ${restockQuantity}.`);
            displayMessage(document.getElementById('stock-message-area'), 'Stock being updated...', 'info');

            try {
                await db.collection('stock').doc(productId).update({
                    quantity: firebase.firestore.FieldValue.increment(restockQuantity),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                displayMessage(document.getElementById('stock-message-area'), 'Stock successfully updated.', 'success');
                quantityInput.value = '';
            } catch (error) {
                console.error("Error restocking:", error);
                displayMessage(document.getElementById('stock-message-area'), `${translations[currentLanguage]['Failed to re-stock:']} ${error.message}`, 'error');
            }
        }

        // Load Order Return Products
        async function loadOrderReturnProducts() {
            console.log("Loading products for order return section...");
            returnProductSelect.innerHTML = `<option value="">${translations[currentLanguage]['Select Product']}</option>`;
            try {
                const snapshot = await db.collection('stock').get();
                if (snapshot.empty) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = translations[currentLanguage]['No products available'];
                    option.disabled = true;
                    returnProductSelect.appendChild(option);
                }
                snapshot.forEach(doc => {
                    const product = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${currentLanguage === 'en' ? product.name_en : product.name_ar} - ${translations[currentLanguage]['Remaining Stock:']} ${product.quantity} ${product.quantity_type}`;
                    returnProductSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading return products:", error);
                displayMessage(document.getElementById('return-message-area'), `${translations[currentLanguage]['Failed to load return products:']} ${error.message}`, 'error');
            }
        }

        // Order Return Handler
        if (returnProductForm) {
            returnProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Order return form submitted.");

                const productId = document.getElementById('return-product-select').value;
                const returnQuantity = parseInt(document.getElementById('return-quantity').value);

                if (!productId || isNaN(returnQuantity) || returnQuantity <= 0) {
                    displayMessage(document.getElementById('return-message-area'), 'Please select product and valid quantity.', 'error');
                    return;
                }

                displayMessage(document.getElementById('return-message-area'), 'Product being returned...', 'info');

                try {
                    const productRef = db.collection('stock').doc(productId);
                    const productDoc = await productRef.get();

                    if (productDoc.exists) {
                        const currentQuantity = productDoc.data().quantity;
                        // No direct check for currentQuantity < returnQuantity here as it's a "return"
                        // If it's a return that *adds* to stock, the logic below is fine.
                        // If it's a return from customer (deducting from *customer's* imagined stock)
                        // then the business logic might be different. Assuming it adds to warehouse stock for now.

                        await productRef.update({
                            quantity: firebase.firestore.FieldValue.increment(returnQuantity), // Increment as it's a return *to* stock
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        await db.collection('returns').add({
                            productId: productId,
                            productName_en: productDoc.data().name_en,
                            productName_ar: productDoc.data().name_ar,
                            returnQuantity: returnQuantity,
                            quantity_type: productDoc.data().quantity_type,
                            returnDate: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        displayMessage(document.getElementById('return-message-area'), 'Product successfully returned and stock updated.', 'success');
                        returnProductForm.reset();
                        loadOrderReturnProducts();
                    } else {
                        displayMessage(document.getElementById('return-message-area'), 'Product not found.', 'error');
                    }
                } catch (error) {
                    console.error("Error returning product:", error);
                    displayMessage(document.getElementById('return-message-area'), `${translations[currentLanguage]['Failed to return product:']} ${error.message}`, 'error');
                }
            });
        }

        // --- User Panel Functionality ---

        // Load Product List for User
        async function loadUserProducts(category) {
            console.log("Loading user products for category:", category);
            productList.innerHTML = `<p>${translations[currentLanguage]['Loading Products...']}</p>`;
            db.collection('products').where('category', '==', category)
                .onSnapshot(snapshot => {
                    productList.innerHTML = '';
                    if (snapshot.empty) {
                        productList.innerHTML = `<p>${translations[currentLanguage]['No products in this category.']}</p>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const product = doc.data();
                        const productId = doc.id;
                        const productDiv = document.createElement('div');
                        productDiv.classList.add('product-item');
                        productDiv.innerHTML = `
                            <h4>${currentLanguage === 'en' ? product.name_en : product.name_ar}</h4>
                            <p>${translations[currentLanguage]['Available:']} <span id="stock-${productId}">লোডিং...</span> ${product.quantity_type}</p>
                            <div class="quantity-control">
                                <button class="add-to-cart-btn" data-product-id="${productId}" data-product-name-en="${product.name_en}" data-product-name-ar="${product.name_ar}" data-quantity-type="${product.quantity_type}">+</button>
                                <span id="cart-quantity-${productId}">${userCart[productId] ? userCart[productId].quantity : 0}</span>
                                <button class="remove-from-cart-btn" data-product-id="${productId}">-</button>
                            </div>
                        `;
                        productList.appendChild(productDiv);
                        db.collection('stock').doc(productId).onSnapshot(stockDoc => {
                            const stockSpan = document.getElementById(`stock-${productId}`);
                            if (stockSpan) {
                                if (stockDoc.exists) {
                                    stockSpan.textContent = stockDoc.data().quantity;
                                } else {
                                    stockSpan.textContent = '0';
                                }
                            }
                        });
                    });
                }, error => {
                    console.error("Error loading user products:", error);
                    displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Failed to load products:']} ${error.message}`, 'error');
                });
        }

        // Update Cart Summary Display
        function updateCartSummary() {
            userCartSummary.innerHTML = '';
            if (Object.keys(userCart).length === 0) {
                userCartSummary.innerHTML = `<p>${translations[currentLanguage]['Your cart is empty.']}</p>`;
                return;
            }

            let cartHtml = '<ul>';
            for (const productId in userCart) {
                const item = userCart[productId];
                cartHtml += `<li>${currentLanguage === 'en' ? item.name_en : item.name_ar}: <strong>${item.quantity}</strong> ${item.type}</li>`;
            }
            cartHtml += '</ul>';
            userCartSummary.innerHTML = cartHtml;
        }

        // Add/Remove from Cart
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.productId;
                const productNameEn = e.target.dataset.productNameEn;
                const productNameAr = e.target.dataset.productNameAr;
                const quantityType = e.target.dataset.quantityType;

                const stockDoc = await db.collection('stock').doc(productId).get();
                const currentStock = stockDoc.exists ? stockDoc.data().quantity : 0;

                if (!userCart[productId]) {
                    userCart[productId] = {
                        name_en: productNameEn,
                        name_ar: productNameAr,
                        quantity: 0,
                        type: quantityType
                    };
                }

                if (userCart[productId].quantity < currentStock) {
                    userCart[productId].quantity++;
                    displayMessage(userOrderMessageArea, translations[currentLanguage]['Added to cart.'], 'success');
                } else {
                    displayMessage(userOrderMessageArea, translations[currentLanguage]['Out of stock, cannot add more.'], 'error');
                }
                document.getElementById(`cart-quantity-${productId}`).textContent = userCart[productId].quantity;
                updateCartSummary();
            } else if (e.target.classList.contains('remove-from-cart-btn')) {
                const productId = e.target.dataset.productId;
                if (userCart[productId] && userCart[productId].quantity > 0) {
                    userCart[productId].quantity--;
                    document.getElementById(`cart-quantity-${productId}`).textContent = userCart[productId].quantity;
                    if (userCart[productId].quantity === 0) {
                        delete userCart[productId];
                    }
                    displayMessage(userOrderMessageArea, translations[currentLanguage]['Removed from cart.'], 'success');
                }
                updateCartSummary();
            }
        });

        // Place Order
        if (placeOrderBtn) {
            placeOrderBtn.addEventListener('click', async () => {
                if (Object.keys(userCart).length === 0) {
                    displayMessage(userOrderMessageArea, translations[currentLanguage]['Your cart is empty.'], 'error');
                    return;
                }

                const confirmOrder = confirm(currentLanguage === 'en' ? "Are you sure you want to place this order?" : "هل أنت متأكد أنك تريد تقديم هذا الطلب؟");
                if (!confirmOrder) return;

                console.log("Placing order...");
                displayMessage(userOrderMessageArea, 'Order being placed...', 'info');

                // Pre-check stock before placing order
                for (const productId in userCart) {
                    const requestedQuantity = userCart[productId].quantity;
                    const stockDoc = await db.collection('stock').doc(productId).get();
                    if (!stockDoc.exists || stockDoc.data().quantity < requestedQuantity) {
                        displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Sorry, insufficient stock for']} ${currentLanguage === 'en' ? userCart[productId].name_en : userCart[productId].name_ar}. ${translations[currentLanguage]['Please check your cart.']}`, 'error');
                        return; // Stop if any item has insufficient stock
                    }
                }

                try {
                    await db.collection('orders').add({
                        userId: auth.currentUser.uid,
                        category: currentUserCategory,
                        products: userCart,
                        orderDate: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    });
                    displayMessage(userOrderMessageArea, 'Order successfully placed.', 'success');
                    userCart = {}; // Clear cart after placing order
                    updateCartSummary();
                    loadUserProducts(currentUserCategory);
                    loadUserOrders(auth.currentUser.uid);
                } catch (error) {
                    console.error("Error placing order:", error);
                    displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Failed to place order:']} ${error.message}`, 'error');
                }
            });
        }


        // Show User Order Status (with edit/delete for pending items)
        async function loadUserOrders(userId) {
            console.log("Loading user orders for UID:", userId);
            userOrdersList.innerHTML = `<p>${translations[currentLanguage]['Loading your orders...']}</p>`;
            db.collection('orders').where('userId', '==', userId).orderBy('orderDate', 'desc')
                .onSnapshot(snapshot => {
                    userOrdersList.innerHTML = '';
                    if (snapshot.empty) {
                        userOrdersList.innerHTML = `<p>${translations[currentLanguage]['You have no orders.']}</p>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.classList.add('user-order-item');
                        orderItemDiv.innerHTML = `
                            <p><strong>${translations[currentLanguage]['Order Date:']}</strong> ${order.orderDate.toDate().toLocaleString()}</p>
                            <p><strong>${translations[currentLanguage]['Status:']}</strong> <strong style="color: ${order.status === 'pending' ? '#ffc107' : order.status === 'delivered' ? '#28a745' : '#dc3545'};">${order.status.toUpperCase()}</strong></p>
                            <ul class="editable-order-item-list">
                                ${Object.keys(order.products).map(productId => {
                                    const product = order.products[productId];
                                    return `
                                        <li data-product-id="${productId}" data-order-id="${orderId}" class="order-item-detail">
                                            <span>${currentLanguage === 'en' ? product.name_en : product.name_ar}:</span>
                                            <span class="quantity-display">${product.quantity} ${product.type}</span>
                                            ${order.status === 'pending' ? `
                                            <div class="edit-controls">
                                                <div class="edit-quantity-control">
                                                    <button class="edit-order-item-btn" data-action="decrease">-</button>
                                                    <input type="number" value="${product.quantity}" min="0" class="edit-item-quantity-input">
                                                    <button class="edit-order-item-btn" data-action="increase">+</button>
                                                </div>
                                                <button class="delete-item-btn" data-product-id="${productId}" data-order-id="${orderId}">${currentLanguage === 'en' ? 'Delete' : 'حذف'}</button>
                                                <button class="save-item-edit-btn button-info" data-product-id="${productId}" data-order-id="${orderId}" style="margin-left: 5px;">${currentLanguage === 'en' ? 'Update' : 'تحديث'}</button>
                                            </div>
                                            ` : ''}
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                            ${order.status === 'pending' ? `<button class="button-danger cancel-user-order-btn" data-order-id="${orderId}">${translations[currentLanguage]['Cancel Order']}</button>` : ''}
                        `;
                        userOrdersList.appendChild(orderItemDiv);
                    });

                    document.querySelectorAll('.cancel-user-order-btn').forEach(button => {
                        button.addEventListener('click', handleCancelUserOrder);
                    });
                    document.querySelectorAll('.edit-order-item-btn').forEach(button => {
                        button.addEventListener('click', handleEditOrderItemQuantity);
                    });
                     document.querySelectorAll('.delete-item-btn').forEach(button => {
                        button.addEventListener('click', handleDeleteOrderItem);
                    });
                    document.querySelectorAll('.save-item-edit-btn').forEach(button => {
                        button.addEventListener('click', handleSaveOrderItemEdit);
                    });

                }, error => {
                    console.error("Error loading user orders:", error);
                    displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Failed to load your orders:']} ${error.message}`, 'error');
                });
        }

        // Handle quantity change for order item edit
        function handleEditOrderItemQuantity(event) {
            const button = event.target;
            const action = button.dataset.action;
            const input = button.closest('.edit-quantity-control').querySelector('.edit-item-quantity-input');
            let currentValue = parseInt(input.value);

            if (action === 'increase') {
                input.value = currentValue + 1;
            } else if (action === 'decrease' && currentValue > 0) {
                input.value = currentValue - 1;
            }
        }

        // Handle saving edited order item quantity
        async function handleSaveOrderItemEdit(event) {
            const button = event.target;
            const orderId = button.dataset.orderId;
            const productId = button.dataset.productId;
            const newQuantity = parseInt(button.closest('li').querySelector('.edit-item-quantity-input').value);

            if (isNaN(newQuantity) || newQuantity < 0) {
                displayMessage(userOrderMessageArea, 'Please enter a valid quantity.', 'error');
                return;
            }

            console.log(`Updating order ${orderId}, product ${productId} to new quantity: ${newQuantity}`);
            displayMessage(userOrderMessageArea, 'Order being updated...', 'info');

            try {
                const orderRef = db.collection('orders').doc(orderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) {
                    displayMessage(userOrderMessageArea, 'Order not found!', 'error');
                    return;
                }

                const currentOrder = orderDoc.data();
                const products = { ...currentOrder.products }; // Create a mutable copy

                if (newQuantity === 0) {
                    // If quantity is 0, delete the item from the order
                    delete products[productId];
                    console.log(`Product ${productId} deleted from order ${orderId}.`);
                } else {
                    // Update quantity
                    const productInStock = await db.collection('stock').doc(productId).get();
                    const availableStock = productInStock.exists ? productInStock.data().quantity : 0;

                    if (newQuantity > availableStock) {
                        displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Insufficient stock for']} ${currentLanguage === 'en' ? products[productId].name_en : products[productId].name_ar}. ${translations[currentLanguage]['Available:']} ${availableStock}.`, 'error');
                        return;
                    }
                    products[productId].quantity = newQuantity;
                    console.log(`Product ${productId} quantity updated to ${newQuantity}.`);
                }

                if (Object.keys(products).length === 0) {
                    // If all items are removed, cancel the entire order
                    await orderRef.update({
                        status: 'cancelled',
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        products: products // Update products to empty object
                    });
                    displayMessage(userOrderMessageArea, 'All items removed. Order successfully cancelled.', 'success');
                } else {
                    // Update the order with the new products map
                    await orderRef.update({
                        products: products,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() // Add an update timestamp
                    });
                    displayMessage(userOrderMessageArea, 'Order successfully updated.', 'success');
                }
            } catch (error) {
                console.error("Error updating order item:", error);
                displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Failed to update order.']} ${error.message}`, 'error');
            }
        }

        // Handle deleting an order item (sets quantity to 0 and calls save logic)
        async function handleDeleteOrderItem(event) {
            const button = event.target;
            const orderId = button.dataset.orderId;
            const productId = button.dataset.productId;
            const confirmDelete = confirm(currentLanguage === 'en' ? "Are you sure you want to delete this item from the order?" : "هل أنت متأكد أنك تريد حذف هذا العنصر من الطلب؟");
            if (!confirmDelete) return;

            console.log(`Deleting product ${productId} from order ${orderId}.`);
            displayMessage(userOrderMessageArea, 'Deleting item from order...', 'info');

            try {
                const orderRef = db.collection('orders').doc(orderId);
                const orderDoc = await orderRef.get();
                if (!orderDoc.exists) {
                    displayMessage(userOrderMessageArea, 'Order not found!', 'error');
                    return;
                }

                const currentOrder = orderDoc.data();
                const products = { ...currentOrder.products }; // Create a mutable copy

                delete products[productId]; // Remove the product

                if (Object.keys(products).length === 0) {
                    // If all items are removed, cancel the entire order
                    await orderRef.update({
                        status: 'cancelled',
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        products: products // Update products to empty object
                    });
                    displayMessage(userOrderMessageArea, 'All items removed. Order successfully cancelled.', 'success');
                } else {
                    // Update the order with the new products map
                    await orderRef.update({
                        products: products,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    displayMessage(userOrderMessageArea, 'Order successfully updated.', 'success');
                }
            } catch (error) {
                console.error("Error deleting order item:", error);
                displayMessage(userOrderMessageArea, `Failed to delete item from order: ${error.message}`, 'error');
            }
        }


        // User Cancel Order Handler
        async function handleCancelUserOrder(event) {
            const orderId = event.target.dataset.orderId;
            const confirmCancel = confirm(currentLanguage === 'en' ? "Are you sure you want to cancel this order?" : "هل أنت متأكد أنك تريد إلغاء هذا الطلب؟");
            if (!confirmCancel) return;

            console.log("Handling user cancel order for ID:", orderId);
            displayMessage(userOrderMessageArea, 'Order being cancelled...', 'info');

            try {
                await db.collection('orders').doc(orderId).update({
                    status: 'cancelled',
                    cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                displayMessage(userOrderMessageArea, 'Order cancelled successfully.', 'success');
            } catch (error) {
                console.error("Error canceling user order:", error);
                displayMessage(userOrderMessageArea, `${translations[currentLanguage]['Failed to cancel order:']} ${error.message}`, 'error');
            }
        }


        // --- Admin Sub-Navigation Button Click Handlers ---
        // These will now trigger showSection and load relevant data
        if (showPendingOrdersBtn) showPendingOrdersBtn.addEventListener('click', () => {
            showSection(adminDashboardSection);
            renderAdminDashboard(); // Ensure pending orders are shown
            document.getElementById('admin-dashboard-content').style.display = 'block'; // Make sure content div is visible
        });
        if (addProductBtn) addProductBtn.addEventListener('click', () => {
            showSection(addProductSection);
        });
        if (lowStockBtn) lowStockBtn.addEventListener('click', () => {
            showSection(lowStockAlertSection);
            loadLowStockAlerts();
        });
        if (totalOrderReportBtn) totalOrderReportBtn.addEventListener('click', () => {
            showSection(totalOrderReportSection);
            loadTotalOrderReport(document.getElementById('report-category').value); // Load report based on current filter
        });
        if (stockRestockBtn) stockRestockBtn.addEventListener('click', () => {
            showSection(stockRestockSection);
            loadStockAndRestock();
        });
        if (orderReturnBtn) orderReturnBtn.addEventListener('click', () => {
            showSection(orderReturnSection);
            loadOrderReturnProducts();
        });

        // Add event listener for the "Show Report" button within the report section
        document.getElementById('generate-report-btn').addEventListener('click', () => {
            const selectedCategory = document.getElementById('report-category').value;
            loadTotalOrderReport(selectedCategory);
        });

        // Event listeners for "Back to Admin Dashboard" buttons
        backToAdminBtns.forEach(button => {
            button.addEventListener('click', () => {
                showSection(adminDashboardSection);
                renderAdminDashboard(); // Re-render the main dashboard view
            });
        });


        // Initialize Firebase Collections on App Load
        window.addEventListener('load', () => {
            console.log("Window loaded. Initializing Firebase collections.");
            initializeFirebaseCollections();

            // Handle initial load based on URL hash (if any)
            const initialHash = window.location.hash.substring(1);
            if (initialHash) {
                const targetSection = document.getElementById(initialHash);
                if (targetSection) {
                    showSection(targetSection);
                    // Manually trigger data load for that section if it's an admin section
                    if (initialHash === 'admin-dashboard-section') renderAdminDashboard();
                    else if (initialHash === 'add-product-section') {} // No data load needed
                    else if (initialHash === 'low-stock-alert-section') loadLowStockAlerts();
                    else if (initialHash === 'total-order-report-section') loadTotalOrderReport();
                    else if (initialHash === 'stock-restock-section') loadStockAndRestock();
                    else if (initialHash === 'order-return-section') loadOrderReturnProducts();
                    else if (initialHash === 'user-panel-section' && auth.currentUser) {
                        // This might be tricky if user isn't logged in yet on page load
                        // Auth state change handler will eventually call loadUserProducts/Orders
                    }
                }
            } else {
                // If no hash, default to login (Auth state change will also handle this)
                showSection(loginSection);
            }
        });

    </script>
</body>
</html>