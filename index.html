<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Khamer Store Management App" data-ar="تطبيق خمر لإدارة المخزون">Khamer Store Management App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa; /* Light grey background */
            color: #343a40; /* Dark grey text */
            line-height: 1.6;
            direction: rtl; /* Default to RTL for Arabic */
            text-align: right; /* Default to right-align for Arabic */
        }
        body.en {
            direction: ltr; /* LTR for English */
            text-align: left; /* Left-align for English */
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header Styles */
        header {
            background-color: #007bff; /* Blue header */
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }
        .app-credit {
            font-size: 0.8em;
            margin-top: 5px;
            color: #d1e7dd; /* Lighter color for credit */
        }

        /* Language Toggle */
        #language-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 1000;
            text-align: center;
        }
        body.en #language-toggle {
            left: 15px;
            right: auto;
        }

        /* Navigation Styles */
        nav {
            display: flex;
            justify-content: center;
            background-color: #343a40; /* Dark grey navigation */
            padding: 15px 0;
            border-radius: 0 0 8px 8px;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        nav button {
            background-color: #6c757d; /* Light grey button */
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px; /* Adjust margin for wrapping */
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        nav button:hover {
            background-color: #5a6268; /* Darker on hover */
            transform: translateY(-2px); /* Slight lift effect */
        }

        /* Section Styles */
        .content-section {
            padding: 30px;
            border-top: 1px solid #dee2e6; /* Light border */
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .content-section h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #007bff; /* Blue heading */
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            text-align: center;
        }

        /* Form Styles */
        form {
            background-color: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .input-field, select {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ced4da; /* Light border */
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: #fcfcfc; /* Slightly off-white for inputs */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .input-field:focus, select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); /* Blue glow on focus */
            outline: none;
        }


        body.ar .input-field, body.ar select {
            text-align: right;
            direction: rtl;
        }
        body.en .input-field, body.en select {
            text-align: left;
            direction: ltr;
        }

        /* Button Styles */
        .button-group {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            margin: 5px;
        }

        .button-success {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
             box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }

        .button-danger {
            background-color: #dc3545; /* Red */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }

        .button-info {
            background-color: #17a2b8; /* Teal */
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 500;
        }

        .button-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.2);
        }

        /* Order Item Styles */
        .order-item, .user-order-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .order-item:hover, .user-order-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .order-item h4, .user-order-item h4 {
            color: #007bff;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .order-item ul, .user-order-item ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 10px;
        }
        body.ar .order-item ul, body.ar .user-order-item ul {
            list-style-type: arabic-indic;
            padding-right: 20px;
            padding-left: 0;
        }

        .order-item li, .user-order-item li {
            margin-bottom: 5px;
            font-size: 0.95em;
        }

        /* Product Item Styles for User Panel */
        .product-item {
            border: 1px solid #e0e0e0;
            padding: 20px; /* Increased padding */
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #e9f7ff; /* Light blue background for products */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .product-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .product-item h4 {
            color: #0056b3; /* Darker blue for product titles */
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .product-item p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .product-item .quantity-control {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .product-item .quantity-control button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%; /* Make it round */
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 0 8px;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
        }

        .product-item .quantity-control button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .product-item .quantity-control span {
            font-size: 1.5em;
            font-weight: bold;
            color: #343a40;
        }

        /* Low Stock Alert Styles */
        .alert-item {
            border: 2px solid #dc3545; /* Stronger red border */
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fdedee; /* Very light red background */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .alert-item p {
            font-weight: 500;
            color: #dc3545;
        }

        /* Stock and Restock Styles */
        .stock-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .stock-item p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .stock-item input {
            margin-bottom: 10px;
            width: calc(100% - 24px);
        }
        .stock-item button { /* Specific style for restock button */
            margin-top: 10px;
            font-size: 0.95em;
            padding: 8px 15px;
            border-radius: 4px;
        }


        /* Login Form Specific */
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .login-form h2 {
            color: #007bff;
            margin-bottom: 25px;
            font-size: 2em;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Message Area for UI Feedback */
        .message-area {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .message-area.error {
            background-color: #fdedee;
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        .message-area.info {
            background-color: #e6f7ff;
            color: #17a2b8;
            border: 1px solid #17a2b8;
        }
        .message-area.success {
            background-color: #e6ffe6;
            color: #28a745;
            border: 1px solid #28a745;
        }

        /* Utility classes for display control */
        .login-form, .admin-dashboard, .user-panel, .product-add-form, .low-stock-alert-section, .total-order-report, .stock-restock-section, .order-return-section {
            display: none; /* Hidden by default */
        }
        .active-section {
            display: block; /* Active section is shown */
        }

        /* Navigation for all pages */
        .global-nav {
            background-color: #495057; /* Darker grey for global nav */
            padding: 10px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .global-nav button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .global-nav button:hover {
            background-color: #5a6268;
        }

        /* Admin Sub-navigation Styling */
        .admin-sub-nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .admin-sub-nav button {
            width: 100%;
            padding: 15px 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background-color: #007bff; /* Primary blue */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .admin-sub-nav button.logout-btn {
            background-color: #dc3545; /* Red for logout */
            box-shadow: 0 4px 6px rgba(220, 53, 69, 0.2);
        }

        .admin-sub-nav button:hover {
            background-color: #0056b3; /* Darker blue on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 123, 255, 0.3);
        }

        .admin-sub-nav button.logout-btn:hover {
            background-color: #c82333; /* Darker red on hover */
            box-shadow: 0 6px 10px rgba(220, 53, 69, 0.3);
        }

        /* Order Edit Specific Styles */
        .editable-order-item-list { /* Changed ul to avoid general ul styles */
            list-style-type: none;
            padding: 0;
        }
        .editable-order-item-list .order-item-detail { /* Changed li to be specific */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .editable-order-item-list .order-item-detail:last-child {
            border-bottom: none;
        }
        .editable-order-item-list .edit-controls {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between edit controls */
        }
        .editable-order-item-list .edit-quantity-control {
            display: flex;
            align-items: center;
        }
        .editable-order-item-list .edit-quantity-control input {
            width: 50px;
            text-align: center;
            margin: 0 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .editable-order-item-list .edit-quantity-control button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        .editable-order-item-list .delete-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        body.ar .editable-order-item-list .delete-item-btn {
             margin-right: 10px;
             margin-left: 0;
        }

        /* Back to Admin Dashboard Button */
        .back-to-admin-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: block; /* Ensures it takes full width or is easily centered */
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .back-to-admin-btn:hover {
            background-color: #5a6268;
        }

        /* Report Section Specific Styles */
        .report-section {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .report-section h3 {
            color: #0056b3;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ced4da;
        }
        .report-section ul {
            list-style: none;
            padding: 0;
        }
        .report-section li {
            background-color: #fff;
            border: 1px solid #e9ecef;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .report-section li p {
            margin: 5px 0;
        }
        
        /* User cart summary */
        #user-cart-summary {
            background-color: #f0f8ff;
            border: 1px dashed #cce7ff;
            padding: 15px;
            border-radius: 8px;
        }
        #user-cart-summary ul {
            list-style: none; /* No bullets for cart items */
            padding: 0;
        }
        #user-cart-summary li {
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px dotted #e0f0ff;
            font-size: 1em;
        }
        #user-cart-summary li:last-child {
            border-bottom: none;
        }


        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of everything */
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: slideInModal 0.3s ease-out;
        }

        @keyframes slideInModal {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-title {
            font-size: 1.8em;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .modal-message {
            font-size: 1.1em;
            color: #343a40;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px; /* Space between buttons */
        }

        .modal-btn {
            flex: 1; /* Make buttons take equal width */
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-btn.button-success:hover {
            background-color: #218838;
        }

        .modal-btn.button-danger:hover {
            background-color: #c82333;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 10px;
            }

            header h1 {
                font-size: 2em;
            }

            nav button {
                padding: 8px 15px;
                margin: 5px; /* Adjust margin for wrapping */
            }

            .content-section {
                padding: 20px;
            }

            .content-section h2 {
                font-size: 1.5em;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .admin-sub-nav {
                grid-template-columns: 1fr; /* Stack buttons vertically on small screens */
            }
        }
    </style>
</head>
<body class="ar">
    <div id="language-toggle" data-en="اللغة العربية" data-ar="English">English</div>
    <div class="container">
        <header>
            <h1 data-en="Khamer Store Management App" data-ar="تطبيق خمر لإدارة المخزون">Khamer Store Management App</h1>
            <p class="app-credit" data-en="This system Created by Amdadul" data-ar="تم إنشاء هذا النظام بواسطة امدادول">This system Created by Amdadul</p>
        </header>

        <main>
            <nav id="global-navigation" class="global-nav" style="display: none;">
                <button id="nav-logout-btn" class="button-danger" data-en="Logout" data-ar="تسجيل الخروج">Logout</button>
            </nav>


            <section id="login-section" class="login-form active-section">
                <h2 data-en="Login" data-ar="تسجيل الدخول">تسجيل الدخول</h2>
                <form id="login-form">
                    <input type="email" id="login-email" data-en-placeholder="Email (Admin)" data-ar-placeholder="البريد الإلكتروني (المسؤول)" placeholder="البريد الإلكتروني (المسؤول)" class="input-field">
                    <input type="password" id="login-password" data-en-placeholder="Password (Admin)" data-ar-placeholder="كلمة المرور (المسؤول)" placeholder="كلمة المرور (المسؤول)" class="input-field">
                    <button type="submit" class="button-success" data-en="Admin Login" data-ar="تسجيل دخول المسؤول">تسجيل دخول المسؤول</button>
                </form>
                <div id="login-message-area" class="message-area"></div>

                <div class="button-group" style="margin-top: 30px;">
                    <button type="button" id="kitchen-login-btn" class="button-info" data-en="Kitchen Login" data-ar="تسجيل دخول المطبخ">تسجيل دخول المطبخ</button>
                    <button type="button" id="men-login-btn" class="button-info" data-en="Men's Section Login" data-ar="تسجيل دخول قسم الرجال">تسجيل دخول قسم الرجال</button>
                    <button type="button" id="women-login-btn" class="button-info" data-en="Women's Section Login" data-ar="تسجيل دخول قسم النساء">تسجيل دخول قسم النساء</button>
                </div>
            </section>

            <section id="admin-dashboard-section" class="admin-dashboard content-section">
                <h2 data-en="Admin Control Panel" data-ar="لوحة تحكم المسؤول">لوحة تحكم المسؤول</h2>
                <nav class="admin-sub-nav">
                    <button id="show-pending-orders-btn" data-en="Pending Orders Management" data-ar="إدارة الطلبات المعلقة">إدارة الطلبات المعلقة</button>
                    <button id="add-product-btn" data-en="Add New Product" data-ar="إضافة منتج جديد">إضافة منتج جديد</button>
                    <button id="low-stock-btn" data-en="Inventory Alerts" data-ar="تنبيهات المخزون">تنبيهات المخزون</button>
                    <button id="total-order-report-btn" data-en="Comprehensive Sales Report" data-ar="تقرير المبيعات الشامل">تقرير المبيعات الشامل</button>
                    <button id="stock-restock-btn" data-en="Manage Stock & Replenish" data-ar="إدارة وتجديد المخزون">إدارة وتجديد المخزون</button>
                    <button id="order-return-btn" data-en="Process Returns" data-ar="معالجة الإرجاع">معالجة الإرجاع</button>
                    <button id="admin-logout-btn" class="logout-btn" data-en="Logout" data-ar="تسجيل الخروج">تسجيل الخروج</button>
                </nav>
                <div id="admin-dashboard-content" style="margin-top: 20px;">
                    <h3 data-en="Pending Orders" data-ar="الطلبات المعلقة">الطلبات المعلقة</h3>
                    <div id="pending-orders-list">
                        </div>
                </div>
                <div id="admin-message-area" class="message-area"></div>
            </section>

            <section id="add-product-section" class="product-add-form content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Add New Product" data-ar="إضافة منتج جديد">إضافة منتج جديد</h2>
                <form id="add-product-form">
                    <input type="text" id="product-name-en" data-en-placeholder="Product Name (English)" data-ar-placeholder="اسم المنتج (الإنجليزية)" placeholder="اسم المنتج (الإنجليزية)" class="input-field" required>
                    <input type="text" id="product-name-ar" data-en-placeholder="Product Name (Arabic)" data-ar-placeholder="اسم المنتج (العربية)" placeholder="اسم المنتج (العربية)" class="input-field" required>
                    <input type="number" id="product-quantity" data-en-placeholder="Quantity (Current Stock)" data-ar-placeholder="الكمية (المخزون الحالي)" placeholder="الكمية (المخزون الحالي)" class="input-field" required min="0">
                    <input type="number" id="low-stock-alert-quantity" data-en-placeholder="Low Stock Alert Quantity" data-ar-placeholder="كمية تنبيه المخزون المنخفض" placeholder="كمية تنبيه المخزون المنخفض" class="input-field" required min="0">
                    <select id="product-category" class="input-field" required>
                        <option value="" data-en="Select Category" data-ar="اختر الفئة">اختر الفئة</option>
                        <option value="kitchen" data-en="Kitchen" data-ar="المطبخ">المطبخ</option>
                        <option value="men" data-en="Men's Section" data-ar="قسم الرجال">قسم الرجال</option>
                        <option value="women" data-en="Women's Section" data-ar="قسم النساء">قسم النساء</option>
                    </select>
                    <select id="quantity-type" class="input-field" required>
                        <option value="" data-en="Select Quantity Type" data-ar="اختر نوع الكمية">اختر نوع الكمية</option>
                        <option value="piece" data-en="Piece" data-ar="قطعة">قطعة</option>
                        <option value="kg" data-en="KG" data-ar="كيلوغرام">كيلوغرام</option>
                        <option value="liter" data-en="Liter" data-ar="لتر">لتر</option>
                        <option value="carton" data-en="Carton" data-ar="كرتون">كرتون</option>
                    </select>
                    <button type="submit" class="button-success" style="width: 100%;" data-en="Add Product" data-ar="إضافة منتج">إضافة منتج</button>
                </form>
                <div id="add-product-message-area" class="message-area"></div>
            </section>

            <section id="low-stock-alert-section" class="low-stock-alert-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Inventory Alerts" data-ar="تنبيهات المخزون">تنبيهات المخزون</h2>
                <div id="low-stock-products-list">
                    </div>
                <div id="low-stock-message-area" class="message-area"></div>
            </section>

            <section id="total-order-report-section" class="total-order-report content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Comprehensive Sales Report (Last 3 Months)" data-ar="تقرير المبيعات الشامل (آخر 3 أشهر)">تقرير المبيعات الشامل (آخر 3 أشهر)</h2>
                <div id="report-filters" style="margin-bottom: 20px;">
                    <label for="report-category" style="font-weight: bold; margin-right: 10px;" data-en="Category:" data-ar="الفئة:">الفئة:</label>
                    <select id="report-category" class="input-field" style="width: auto; display: inline-block;">
                        <option value="all" data-en="All" data-ar="الكل">الكل</option>
                        <option value="kitchen" data-en="Kitchen" data-ar="المطبخ">المطبخ</option>
                        <option value="men" data-en="Men's Section" data-ar="قسم الرجال">قسم الرجال</option>
                        <option value="women" data-en="Women's Section" data-ar="قسم النساء">قسم النساء</option>
                    </select>
                    <button id="generate-report-btn" class="button-info" style="margin-left: 10px;" data-en="Show Report" data-ar="عرض التقرير">عرض التقرير</button>
                </div>
                <div id="total-order-report-content">
                    </div>
                <div id="report-message-area" class="message-area"></div>
            </section>

            <section id="stock-restock-section" class="stock-restock-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Manage Stock & Replenish" data-ar="إدارة وتجديد المخزون">إدارة وتجديد المخزون</h2>
                <div id="current-stock-list">
                    </div>
                <div id="stock-message-area" class="message-area"></div>
            </section>

            <section id="order-return-section" class="order-return-section content-section">
                <button class="back-to-admin-btn" data-en="Back to Admin Dashboard" data-ar="العودة للوحة تحكم المسؤول">العودة للوحة تحكم المسؤول</button>
                <h2 data-en="Process Returns" data-ar="معالجة الإرجاع">معالجة الإرجاع</h2>
                <form id="return-product-form">
                    <select id="return-product-select" class="input-field" required>
                        <option value="" data-en="Select Product" data-ar="اختر المنتج">اختر المنتج</option>
                        </select>
                    <input type="number" id="return-quantity" data-en-placeholder="Return Quantity" data-ar-placeholder="كمية الإرجاع" placeholder="كمية الإرجاع" class="input-field" required min="1">
                    <button type="submit" class="button-danger" style="width: 100%;" data-en="Return Product" data-ar="إرجاع المنتج">إرجاع المنتج</button>
                </form>
                <div id="return-message-area" class="message-area"></div>
            </section>

            <section id="user-panel-section" class="user-panel content-section">
                <h2 id="user-panel-title" data-en="User Panel" data-ar="لوحة المستخدم">لوحة المستخدم</h2>
                <button id="user-logout-btn" class="button-danger" style="margin-bottom: 20px;" data-en="Logout" data-ar="تسجيل الخروج">تسجيل الخروج</button>

                <h3 data-en="Products to Order" data-ar="المنتجات للطلب">المنتجات للطلب</h3>
                <div id="product-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    </div>

                <h3 data-en="Your Cart" data-ar="سلتك">سلتك</h3>
                <div id="user-cart-summary" style="margin-bottom: 20px;">
                    </div>
                <button id="place-order-btn" class="button-success" style="width: 100%; margin-top: 10px;" data-en="Place Order" data-ar="تقديم الطلب">تقديم الطلب</button>
                <div id="user-order-message-area" class="message-area"></div>


                <h3 data-en="Your Previous Orders" data-ar="طلباتك السابقة">طلباتك السابقة</h3>
                <div id="user-orders-list">
                    </div>
            </section>
        </main>
    </div>

    <div id="custom-alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title"></h3>
            <p id="modal-message" class="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="button-danger modal-btn"></button>
                <button id="modal-ok-btn" class="button-success modal-btn"></button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBnvcS8kpOrebq66LzQ2hz5Kvv_z_pu5p4",
            authDomain: "stock-5d278.firebaseapp.com",
            projectId: "stock-5d278",
            storageBucket: "stock-5d278.firebasestorage.app",
            messagingSenderId: "730697386577",
            appId: "1:730697386577:web:8b7ef78adac14ee5990670",
            measurementId: "G-CFNVGX1S4W"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const userPanelSection = document.getElementById('user-panel-section');
        const addProductSection = document.getElementById('add-product-section');
        const lowStockAlertSection = document.getElementById('low-stock-alert-section');
        const totalOrderReportSection = document.getElementById('total-order-report-section');
        const stockRestockSection = document.getElementById('stock-restock-section');
        const orderReturnSection = document.getElementById('order-return-section');

        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessageArea = document.getElementById('login-message-area');

        const kitchenLoginBtn = document.getElementById('kitchen-login-btn');
        const menLoginBtn = document.getElementById('men-login-btn');
        const womenLoginBtn = document.getElementById('women-login-btn');

        // Admin Sub-navigation Buttons
        const showPendingOrdersBtn = document.getElementById('show-pending-orders-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const lowStockBtn = document.getElementById('low-stock-btn');
        const totalOrderReportBtn = document.getElementById('total-order-report-btn');
        const stockRestockBtn = document.getElementById('stock-restock-btn');
        const orderReturnBtn = document.getElementById('order-return-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const userLogoutBtn = document.getElementById('user-logout-btn');

        const pendingOrdersList = document.getElementById('pending-orders-list');
        const addProductForm = document.getElementById('add-product-form');
        const addProductMessageArea = document.getElementById('add-product-message-area');
        const lowStockProductsList = document.getElementById('low-stock-products-list');
        const totalOrderReportContent = document.getElementById('total-order-report-content');
        const currentStockList = document.getElementById('current-stock-list');
        const returnProductForm = document.getElementById('return-product-form');
        const returnProductSelect = document.getElementById('return-product-select');

        const productList = document.getElementById('product-list');
        const userCartSummary = document.getElementById('user-cart-summary');
        const userOrdersList = document.getElementById('user-orders-list');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const userPanelTitle = document.getElementById('user-panel-title');
        const userOrderMessageArea = document.getElementById('user-order-message-area');

        const globalNavigation = document.getElementById('global-navigation');
        const navLogoutBtn = document.getElementById('nav-logout-btn'); // Renamed for clarity in global nav

        // All back-to-admin-dashboard buttons
        const backToAdminBtns = document.querySelectorAll('.back-to-admin-btn');

        // Custom Modal Elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');


        // --- Global Variables ---
        let currentUserCategory = null;
        let userCart = {};

        // --- Language Management ---
        let currentLanguage = 'ar'; // Default language

        const translations = {
            'en': {
                'Khamer Store Management App': 'Khamer Store Management App',
                'This system Created by Amdadul': 'This system Created by Amdadul',
                'Login': 'Login',
                'Email (Admin)': 'Email (Admin)',
                'Password (Admin)': 'Password (Admin)',
                'Admin Login': 'Admin Login',
                'Kitchen Login': 'Kitchen Login',
                'Men\'s Section Login': 'Men\'s Section Login',
                'Women\'s Section Login': 'Women\'s Section Login',
                'Admin Control Panel': 'Admin Control Panel', // New
                'Pending Orders Management': 'Pending Orders Management', // Changed
                'Add New Product': 'Add New Product', // Changed
                'Inventory Alerts': 'Inventory Alerts', // Changed
                'Comprehensive Sales Report': 'Comprehensive Sales Report', // Changed
                'Manage Stock & Replenish': 'Manage Stock & Replenish', // Changed
                'Process Returns': 'Process Returns', // Changed
                'Logout': 'Logout',
                'Pending Orders': 'Pending Orders',
                'Loading Orders...': 'Loading Orders...',
                'No pending orders.': 'No pending orders.',
                'Department:': 'Department:',
                'Order ID:': 'Order ID:',
                'Order Date:': 'Order Date:',
                'Delivered': 'Delivered',
                'Cancel': 'Cancel',
                'Error loading orders:': 'Error loading orders:',
                'Order successfully delivered and stock updated.': 'Order successfully delivered and stock updated.',
                'Failed to deliver order.': 'Failed to deliver order.',
                'Order successfully cancelled.': 'Order successfully cancelled.',
                'Failed to cancel order.': 'Failed to cancel order.',
                'Product Name (English)': 'Product Name (English)',
                'Product Name (Arabic)': 'Product Name (Arabic)',
                'Quantity (Current Stock)': 'Quantity (Current Stock)',
                'Low Stock Alert Quantity': 'Low Stock Alert Quantity',
                'Select Category': 'Select Category',
                'Kitchen': 'Kitchen',
                'Men\'s Section': 'Men\'s Section',
                'Women\'s Section': 'Women\'s Section',
                'Select Quantity Type': 'Select Quantity Type',
                'Piece': 'Piece',
                'KG': 'KG',
                'Liter': 'Liter',
                'Carton': 'Carton',
                'Add Product': 'Add Product',
                'Please fill all fields correctly.': 'Please fill all fields correctly.',
                'Product already exists in this category.': 'Product already exists in this category.',
                'Product successfully added.': 'Product successfully added.',
                'Failed to add product.': 'Failed to add product.',
                'Loading Inventory Alerts...': 'Loading Inventory Alerts...', // Changed
                'No low stock alerts.': 'No low stock alerts.',
                'Current Stock:': 'Current Stock:',
                'Alert Quantity:': 'Alert Quantity:',
                'Remove Alert (Display Only)': 'Remove Alert (Display Only)',
                'Alert successfully removed (display only).': 'Alert successfully removed (display only).',
                'Error loading inventory alerts:': 'Error loading inventory alerts:', // Changed
                'Comprehensive Sales Report (Last 3 Months)': 'Comprehensive Sales Report (Last 3 Months)', // Changed
                'Category:': 'Category:',
                'All': 'All',
                'Show Report': 'Show Report',
                'Loading Report...': 'Loading Report...',
                'No delivered order reports found.': 'No delivered order reports found.',
                'Order ID:': 'Order ID:',
                'Delivery Date:': 'Delivery Date:',
                'Share/Download PDF': 'Share/Download PDF',
                'Report load successful.': 'Report load successful.',
                'Failed to load report:': 'Failed to load report:',
                'Report content not found.': 'Report content not found.',
                'Generating PDF...': 'Generating PDF...',
                'PDF successfully downloaded.': 'PDF successfully downloaded.',
                'Loading Stock...': 'Loading Stock...',
                'No stock items.': 'No stock items.',
                'Remaining Stock:': 'Remaining Stock:',
                'Re-stock Quantity': 'Re-stock Quantity',
                'Re-stock': 'Re-stock',
                'Failed to load stock:': 'Failed to load stock:',
                'Stock successfully updated.': 'Stock successfully updated.',
                'Failed to re-stock:': 'Failed to re-stock:',
                'Select Product': 'Select Product',
                'No products available': 'No products available',
                'Return Quantity': 'Return Quantity',
                'Return Product': 'Return Product',
                'Please select product and valid quantity.': 'Please select product and valid quantity.',
                'Product being returned...': 'Product being returned...',
                'Cannot return more than current stock.': 'Cannot return more than current stock.',
                'Product successfully returned and stock updated.': 'Product successfully returned and stock updated.',
                'Product not found.': 'Product not found.',
                'Failed to return product:': 'Failed to return product:',
                'User Panel': 'User Panel',
                'Products to Order': 'Products to Order',
                'Loading Products...': 'Loading Products...',
                'No products in this category.': 'No products in this category.',
                'Available:': 'Available:',
                'Your Cart': 'Your Cart',
                'Added to cart.': 'Added to cart.',
                'Out of stock, cannot add more.': 'Out of stock, cannot add more.',
                'Removed from cart.': 'Removed from cart.',
                'Your cart is empty.': 'Your cart is empty.', // Used twice, keep for clarity
                'Place Order': 'Place Order',
                'Order being placed...': 'Order being placed...',
                'Sorry, insufficient stock for': 'Sorry, insufficient stock for',
                'Please check your cart.': 'Please check your cart.',
                'Order successfully placed.': 'Order successfully placed.',
                'Failed to place order:': 'Failed to place order:',
                'Your Previous Orders': 'Your Previous Orders',
                'Loading your orders...': 'Loading your orders...',
                'You have no orders.': 'You have no orders.',
                'Status:': 'Status:',
                'Cancel Order': 'Cancel Order',
                'Order cancelled successfully.': 'Order cancelled successfully.',
                'Failed to cancel order:': 'Failed to cancel order:',
                'Problem fetching your data:': 'Problem fetching your data:',
                'Unknown user category. Please log in again.': 'Unknown user category. Please log in again.',
                'Login in progress... please wait.': 'Login in progress... please wait.',
                'Login successful.': 'Login successful.',
                'Login failed:': 'Login failed:',
                'Email and password required.': 'Email and password required.',
                'Form elements not loaded.': 'Form elements not loaded.',
                'Admin setup error:': 'Admin setup error:',
                'Admin user document created. Role set to admin.': 'Admin user document created. Role set to admin.',
                'Logout successful.': 'Logout successful.',
                'Warning:': 'Warning:',
                'is out of stock.': 'is out of stock.',
                'Language Arabic': 'Language Arabic',
                'Order Update': 'Order Update',
                'Update Order': 'Update Order',
                'Order successfully updated.': 'Order successfully updated.',
                'Failed to update order.': 'Failed to update order.',
                'Access Denied. Please log in as Admin.': 'Access Denied. Please log in as Admin.',
                'Access Denied. Please log in as a regular user.': 'Access Denied. Please log in as a regular user.',
                'Back to Admin Dashboard': 'Back to Admin Dashboard', // New
                'Login cancelled.': 'Login cancelled.', // New
                'Wrong password.': 'Wrong password.', // New
                'Insufficient stock for': 'Insufficient stock for', // New
                'Delete': 'Delete', // For item deletion in user order
                'Enter Return Passcode:': 'Enter Return Passcode:', // For return passcode prompt
                'Incorrect Passcode.': 'Incorrect Passcode.', // For return passcode error
                'Return cancelled.': 'Return cancelled.', // For return passcode cancelled
                'Confirm': 'Confirm', // For custom modal confirm button
                'Alert': 'Alert', // For custom modal title
                'Success': 'Success',
                'Error': 'Error',
                'Warning': 'Warning',
                'Please enter the passcode to authorize the return:': 'Please enter the passcode to authorize the return:',
            },
            'ar': {
                'Khamer Store Management App': 'تطبيق خمر لإدارة المخزون',
                'This system Created by Amdadul': 'تم إنشاء هذا النظام بواسطة امدادول',
                'Login': 'تسجيل الدخول',
                'Email (Admin)': 'البريد الإلكتروني (المسؤول)',
                'Password (Admin)': 'كلمة المرور (المسؤول)',
                'Admin Login': 'تسجيل دخول المسؤول',
                'Kitchen Login': 'تسجيل دخول المطبخ',
                'Men\'s Section Login': 'تسجيل دخول قسم الرجال',
                'Women\'s Section Login': 'تسجيل دخول قسم النساء',
                'Admin Control Panel': 'لوحة تحكم المسؤول', // New
                'Pending Orders Management': 'إدارة الطلبات المعلقة', // Changed
                'Add New Product': 'إضافة منتج جديد', // Changed
                'Inventory Alerts': 'تنبيهات المخزون', // Changed
                'Comprehensive Sales Report': 'تقرير المبيعات الشامل', // Changed
                'Manage Stock & Replenish': 'إدارة وتجديد المخزون', // Changed
                'Process Returns': 'معالجة الإرجاع', // Changed
                'Logout': 'تسجيل الخروج',
                'Pending Orders': 'الطلبات المعلقة',
                'Loading Orders...': 'جارٍ تحميل الطلبات...',
                'No pending orders.': 'لا توجد طلبات معلقة.',
                'Department:': 'القسم:',
                'Order ID:': 'رقم الطلب:',
                'Order Date:': 'تاريخ الطلب:',
                'Delivered': 'تم التوصيل',
                'Cancel': 'إلغاء',
                'Error loading orders:': 'خطأ في تحميل الطلبات:',
                'Order successfully delivered and stock updated.': 'تم توصيل الطلب وتحديث المخزون بنجاح.',
                'Failed to deliver order.': 'فشل في توصيل الطلب.',
                'Order successfully cancelled.': 'تم إلغاء الطلب بنجاح.',
                'Failed to cancel order.': 'فشل في إلغاء الطلب.',
                'Product Name (English)': 'اسم المنتج (الإنجليزية)',
                'Product Name (Arabic)': 'اسم المنتج (العربية)',
                'Quantity (Current Stock)': 'الكمية (المخزون الحالي)',
                'Low Stock Alert Quantity': 'كمية تنبيه المخزون المنخفض',
                'Select Category': 'اختر الفئة',
                'Kitchen': 'المطبخ',
                'Men\'s Section': 'قسم الرجال',
                'Women\'s Section': 'قسم النساء',
                'Select Quantity Type': 'اختر نوع الكمية',
                'Piece': 'قطعة',
                'KG': 'كيلوغرام',
                'Liter': 'لتر',
                'Carton': 'كرتون',
                'Add Product': 'إضافة منتج',
                'Please fill all fields correctly.': 'يرجى ملء جميع الحقول بشكل صحيح.',
                'Product already exists in this category.': 'المنتج موجود بالفعل في هذه الفئة.',
                'Product successfully added.': 'تمت إضافة المنتج بنجاح.',
                'Failed to add product.': 'فشل في إضافة المنتج.',
                'Loading Inventory Alerts...': 'جارٍ تحميل تنبيهات المخزون...', // Changed
                'No low stock alerts.': 'لا توجد تنبيهات مخزون منخفض.',
                'Current Stock:': 'المخزون الحالي:',
                'Alert Quantity:': 'كمية التنبيه:',
                'Remove Alert (Display Only)': 'إزالة التنبيه (للعرض فقط)',
                'Alert successfully removed (display only).': 'تمت إزالة التنبيه بنجاح (للعرض فقط).',
                'Error loading inventory alerts:': 'خطأ في تحميل تنبيهات المخزون:', // Changed
                'Comprehensive Sales Report (Last 3 Months)': 'تقرير المبيعات الشامل (آخر 3 أشهر)', // Changed
                'Category:': 'الفئة:',
                'All': 'الكل',
                'Show Report': 'عرض التقرير',
                'Loading Report...': 'جارٍ تحميل التقرير...',
                'No delivered order reports found.': 'لم يتم العثور على تقارير طلبات تم تسليمها.',
                'Order ID:': 'رقم الطلب:',
                'Delivery Date:': 'تاريخ التسليم:',
                'Share/Download PDF': 'مشاركة/تنزيل PDF',
                'Report load successful.': 'تم تحميل التقرير بنجاح.',
                'Failed to load report:': 'فشل في تحميل التقرير:',
                'Report content not found.': 'لم يتم العثور على محتوى التقرير.',
                'Generating PDF...': 'جارٍ إنشاء PDF...',
                'PDF successfully downloaded.': 'تم تنزيل PDF بنجاح.',
                'Loading Stock...': 'جارٍ تحميل المخزون...',
                'No stock items.': 'لا توجد عناصر في المخزون.',
                'Remaining Stock:': 'المخزون المتبقي:',
                'Re-stock Quantity': 'كمية إعادة التخزين',
                'Re-stock': 'إعادة التخزين',
                'Failed to load stock:': 'فشل في تحميل المخزون:',
                'Stock successfully updated.': 'تم تحديث المخزون بنجاح.',
                'Failed to re-stock:': 'فشل في إعادة التخزين:',
                'Select Product': 'اختر المنتج',
                'No products available': 'لا توجد منتجات متاحة',
                'Return Quantity': 'كمية الإرجاع',
                'Return Product': 'إرجاع المنتج',
                'Please select product and valid quantity.': 'الرجاء تحديد المنتج وكمية صالحة.',
                'Product being returned...': 'جارٍ إرجاع المنتج...',
                'Cannot return more than current stock.': 'لا يمكن إرجاع كمية أكبر من المخزون الحالي.',
                'Product successfully returned and stock updated.': 'تم إرجاع المنتج بنجاح وتحديث المخزون.',
                'Product not found.': 'لم يتم العثور على المنتج.',
                'Failed to return product:': 'فشل في إرجاع المنتج:',
                'User Panel': 'لوحة المستخدم',
                'Products to Order': 'المنتجات للطلب',
                'Loading Products...': 'جارٍ تحميل المنتجات...',
                'No products in this category.': 'لا توجد منتجات في هذه الفئة.',
                'Available:': 'متاح:',
                'Your Cart': 'سلتك',
                'Added to cart.': 'تمت الإضافة إلى السلة.',
                'Out of stock, cannot add more.': 'المخزون غير كافٍ، لا يمكن إضافة المزيد.',
                'Removed from cart.': 'تمت الإزالة من السلة.',
                'Your cart is empty.': 'سلتك فارغة.',
                'Place Order': 'تقديم الطلب',
                'Order being placed...': 'جارٍ تقديم الطلب...',
                'Sorry, insufficient stock for': 'عذرًا، المخزون غير كافٍ لـ',
                'Please check your cart.': 'يرجى مراجعة سلتك.',
                'Order successfully placed.': 'تم تقديم الطلب بنجاح.',
                'Failed to place order:': 'فشل في تقديم الطلب:',
                'Your Previous Orders': 'طلباتك السابقة',
                'Loading your orders...': 'جارٍ تحميل طلباتك...',
                'You have no orders.': 'ليس لديك طلبات.',
                'Status:': 'الحالة:',
                'Cancel Order': 'إلغاء الطلب',
                'Order cancelled successfully.': 'تم إلغاء الطلب بنجاح.',
                'Failed to cancel order:': 'فشل في إلغاء الطلب:',
                'Problem fetching your data:': 'مشكلة في جلب بياناتك:',
                'Unknown user category. Please log in again.': 'فئة مستخدم غير معروفة. يرجى تسجيل الدخول مرة أخرى.',
                'Login in progress... please wait.': 'جارٍ تسجيل الدخول... يرجى الانتظار.',
                'Login successful.': 'تم تسجيل الدخول بنجاح.',
                'Login failed:': 'فشل تسجيل الدخول:',
                'Email and password required.': 'البريد الإلكتروني وكلمة المرور مطلوبان.',
                'Form elements not loaded.': 'لم يتم تحميل عناصر النموذج.',
                'Admin setup error:': 'خطأ في إعداد المسؤول:',
                'Admin user document created. Role set to admin.': 'تم إنشاء مستند مستخدم المسؤول. تم تعيين الدور للمسؤول.',
                'Logout successful.': 'تم تسجيل الخروج بنجاح.',
                'Warning:': 'تحذير:',
                'is out of stock.': 'نفد المخزون.',
                'Language Arabic': 'اللغة العربية',
                'Order Update': 'تحديث الطلب',
                'Update Order': 'تحديث الطلب',
                'Order successfully updated.': 'تم تحديث الطلب بنجاح.',
                'Failed to update order.': 'فشل في تحديث الطلب.',
                'Access Denied. Please log in as Admin.': 'الوصول مرفوض. يرجى تسجيل الدخول كمسؤول.',
                'Access Denied. Please log in as a regular user.': 'الوصول مرفوض. يرجى تسجيل الدخول كمستخدم عادي.',
                'Back to Admin Dashboard': 'العودة للوحة تحكم المسؤول', // New
                'Login cancelled.': 'تم إلغاء تسجيل الدخول.', // New
                'Wrong password.': 'كلمة مرور خاطئة.', // New
                'Insufficient stock for': 'المخزون غير كافٍ لـ', // New
                'Delete': 'حذف',
                'Enter Return Passcode:': 'أدخل رمز المرور للإرجاع:',
                'Incorrect Passcode.': 'رمز مرور خاطئ.',
                'Return cancelled.': 'تم إلغاء الإرجاع.',
                'Confirm': 'تأكيد',
                'Alert': 'تنبيه',
                'Success': 'نجاح',
                'Error': 'خطأ',
                'Warning': 'تحذير',
                'Please enter the passcode to authorize the return:': 'يرجى إدخال رمز المرور لتصريح الإرجاع:',
            }
        };

        const translatableElements = document.querySelectorAll('[data-en], [data-ar-placeholder]');

        function setLanguage(lang) {
            currentLanguage = lang;
            document.body.className = lang; // Set class for RTL/LTR and font-family
            document.querySelector('html').lang = lang; // Set HTML lang attribute

            translatableElements.forEach(el => {
                const enText = el.dataset.en;
                const arText = el.dataset.ar;
                const enPlaceholder = el.dataset.enPlaceholder;
                const arPlaceholder = el.dataset.arPlaceholder;

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (lang === 'en' && enPlaceholder) {
                        el.placeholder = enPlaceholder;
                    } else if (lang === 'ar' && arPlaceholder) {
                        el.placeholder = arPlaceholder;
                    }
                } else if (enText && arText) {
                    el.textContent = lang === 'en' ? enText : arText;
                }
            });
            // Update selected option texts if needed (for select elements)
            document.querySelectorAll('select option').forEach(option => {
                // Check for data-en and data-ar attributes on options if they exist
                const optionEnText = option.dataset.en;
                const optionArText = option.dataset.ar;

                if (optionEnText && optionArText) {
                    option.textContent = lang === 'en' ? optionEnText : optionArText;
                } else {
                    // Fallback to direct translation for common values if data attributes are not consistently set
                    if (option.value === "") {
                        // Check parent select's ID to apply correct 'Select' translation
                        if (option.closest('select').id === 'product-category') {
                             option.textContent = lang === 'en' ? translations.en['Select Category'] : translations.ar['اختر الفئة'];
                        } else if (option.closest('select').id === 'quantity-type') {
                             option.textContent = lang === 'en' ? translations.en['Select Quantity Type'] : translations.ar['اختر نوع الكمية'];
                        } else if (option.closest('select').id === 'return-product-select') {
                             option.textContent = lang === 'en' ? translations.en['Select Product'] : translations.ar['اختر المنتج'];
                        }
                    } else if (option.value === "kitchen") {
                        option.textContent = lang === 'en' ? translations.en['Kitchen'] : translations.ar['المطبخ'];
                    } else if (option.value === "men") {
                        option.textContent = lang === 'en' ? translations.en['Men\'s Section'] : translations.ar['قسم الرجال'];
                    } else if (option.value === "women") {
                        option.textContent = lang === 'en' ? translations.en['Women\'s Section'] : translations.ar['قسم النساء'];
                    } else if (option.value === "piece") {
                        option.textContent = lang === 'en' ? translations.en['Piece'] : translations.ar['قطعة'];
                    } else if (option.value === "kg") {
                        option.textContent = lang === 'en' ? translations.en['KG'] : translations.ar['كيلوغرام'];
                    } else if (option.value === "liter") {
                        option.textContent = lang === 'en' ? translations.en['Liter'] : translations.ar['لتر'];
                    } else if (option.value === "carton") {
                        option.textContent = lang === 'en' ? translations.en['Carton'] : translations.ar['كرتون'];
                    } else if (option.value === "all") {
                        option.textContent = lang === 'en' ? translations.en['All'] : translations.ar['الكل'];
                    }
                }
            });

            // Update specific dynamic texts like user panel title and restock input placeholder
            if (currentUserCategory) {
                userPanelTitle.textContent = translations[currentLanguage]['User Panel'];
            }
            document.querySelectorAll('.restock-quantity').forEach(input => {
                input.placeholder = currentLanguage === 'en' ? translations.en['Re-stock Quantity'] : translations.ar['كمية إعادة التخزين'];
            });
        }

        // Language toggle button
        const languageToggleButton = document.getElementById('language-toggle');
        if (languageToggleButton) {
            languageToggleButton.addEventListener('click', () => {
                const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
                setLanguage(newLang);
                localStorage.setItem('appLang', newLang); // Save preference
                languageToggleButton.textContent = newLang === 'ar' ? languageToggleButton.dataset.ar : languageToggleButton.dataset.en;
            });
        }
        // Load language preference from localStorage
        const savedLang = localStorage.getItem('appLang');
        if (savedLang) {
            setLanguage(savedLang);
            languageToggleButton.textContent = savedLang === 'ar' ? languageToggleButton.dataset.ar : languageToggleButton.dataset.en;
        } else {
            setLanguage('ar'); // Default to Arabic
        }


        // --- Utility Functions ---

        // Function: Display Messages in UI
        function displayMessage(areaElement, messageKey, type) {
            if (!areaElement) {
                console.error("Message area element not found:", areaElement);
                return;
            }
            const message = translations[currentLanguage][messageKey] || messageKey; // Translate if key exists
            areaElement.textContent = message;
            areaElement.className = `message-area ${type}`;
            areaElement.style.display = 'block';
            setTimeout(() => {
                areaElement.style.display = 'none';
                areaElement.textContent = '';
            }, 5000);
        }

        // Function: Custom Confirm Modal
        function showCustomConfirm(titleKey, messageKey) {
            return new Promise((resolve) => {
                modalTitle.textContent = translations[currentLanguage][titleKey] || titleKey;
                modalMessage.textContent = translations[currentLanguage][messageKey] || messageKey;
                modalCancelBtn.textContent = translations[currentLanguage]['Cancel'];
                modalOkBtn.textContent = translations[currentLanguage]['Confirm'];

                customAlertModal.style.display = 'flex';

                const handleConfirm = () => {
                    customAlertModal.style.display = 'none';
                    modalOkBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    customAlertModal.style.display = 'none';
                    modalOkBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                modalOkBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);
            });
        }

        // Function to replace browser's native prompt (for passcode)
        function showCustomPrompt(titleKey, messageKey) {
            return new Promise((resolve) => {
                modalTitle.textContent = translations[currentLanguage][titleKey] || titleKey;
                modalMessage.innerHTML = `${translations[currentLanguage][messageKey]}<br><input type="password" id="modal-prompt-input" class="input-field" style="margin-top: 15px;">`;
                modalCancelBtn.textContent = translations[currentLanguage]['Cancel'];
                modalOkBtn.textContent = translations[currentLanguage]['Confirm'];

                customAlertModal.style.display = 'flex';
                const promptInput = document.getElementById('modal-prompt-input');
                promptInput.focus();

                const handleConfirm = () => {
                    const inputValue = promptInput.value;
                    customAlertModal.style.display = 'none';
                    modalOkBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(inputValue);
                };

                const handleCancel = () => {
                    customAlertModal.style.display = 'none';
                    modalOkBtn.removeEventListener('click', handleConfirm);
                    modalCancelBtn.removeEventListener('click', handleCancel);
                    resolve(null); // Resolve with null if cancelled
                };

                modalOkBtn.addEventListener('click', handleConfirm);
                modalCancelBtn.addEventListener('click', handleCancel);

                // Allow pressing Enter to confirm
                promptInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleConfirm();
                    }
                });
            });
        }

        // Function: Hide and Show Sections with History Management
        function showSection(sectionToShow, state = null) {
            console.log("Attempting to show section:", sectionToShow ? sectionToShow.id : "null", "with state:", state);
            const sections = [
                loginSection, adminDashboardSection, userPanelSection, addProductSection,
                lowStockAlertSection, totalOrderReportSection, stockRestockSection, orderReturnSection
            ];
            sections.forEach(section => {
                if (section) section.classList.remove('active-section');
            });

            if (sectionToShow) {
                sectionToShow.classList.add('active-section');

                // Update global navigation visibility
                if (sectionToShow === loginSection) {
                    globalNavigation.style.display = 'none';
                } else {
                    globalNavigation.style.display = 'flex';
                }

                // Manage browser history for back button functionality
                const sectionId = sectionToShow.id;
                if (history.state && history.state.sectionId === sectionId) {
                    // Do nothing if already on this state to avoid duplicate history entries
                } else {
                    history.pushState({ sectionId: sectionId, category: currentUserCategory }, '', `#${sectionId}`);
                }
            } else {
                console.error("Section to show is null:", sectionToShow);
            }
        }

        // Handle browser's back/forward button
        window.addEventListener('popstate', (event) => {
            console.log("Popstate event triggered. State:", event.state);
            if (event.state && event.state.sectionId) {
                const targetSection = document.getElementById(event.state.sectionId);
                if (targetSection) {
                    // Directly show the section without pushing another history state
                    const sections = [
                        loginSection, adminDashboardSection, userPanelSection, addProductSection,
                        lowStockAlertSection, totalOrderReportSection, stockRestockSection, orderReturnSection
                    ];
                    sections.forEach(section => {
                        if (section) section.classList.remove('active-section');
                    });
                    targetSection.classList.add('active-section');

                    // Re-run data loading for the section if necessary
                    if (targetSection === adminDashboardSection) {
                        loadAdminDashboard();
                    } else if (targetSection === addProductSection) {
                        // Nothing specific needed here, form is static
                    } else if (targetSection === lowStockAlertSection) {
                        loadLowStockAlerts();
                    } else if (targetSection === totalOrderReportSection) {
                        loadTotalOrderReport(); // Reload with default 'all' category
                    } else if (targetSection === stockRestockSection) {
                        loadStockAndRestock();
                    } else if (targetSection === orderReturnSection) {
                        loadOrderReturnProducts();
                    } else if (targetSection === userPanelSection && event.state.category) {
                         currentUserCategory = event.state.category; // Restore category
                         loadUserProducts(currentUserCategory);
                         loadUserOrders(auth.currentUser.uid);
                         updateCartSummary();
                    }
                     // Update global navigation visibility
                    if (targetSection === loginSection) {
                        globalNavigation.style.display = 'none';
                    } else {
                        globalNavigation.style.display = 'flex';
                    }
                }
            } else {
                // If no state, go back to login or default
                showSection(loginSection);
            }
        });


        // --- Firebase Collection Initialization ---
        async function initializeFirebaseCollections() {
            console.log("Checking Firebase collections for initialization...");
            const collections = ['products', 'orders', 'stock', 'returns', 'users'];
            for (const collectionName of collections) {
                try {
                    // Attempt to get a dummy doc to see if collection exists
                    const docRef = db.collection(collectionName).doc('__dummy_init__');
                    await docRef.get(); // Just try to read, doesn't need to exist
                    console.log(`Collection '${collectionName}' already seems to exist.`);
                } catch (error) {
                    if (error.code === 'not-found' || error.code === 'permission-denied') {
                        // If 'not-found' or 'permission-denied' (implying collection not there for current user),
                        // or other errors that mean it's not initialized, then create a dummy doc and delete
                        try {
                            const initDocRef = db.collection(collectionName).doc('__init__');
                            await initDocRef.set({ initialized: true });
                            await initDocRef.delete();
                            console.log(`Collection '${collectionName}' initialized successfully.`);
                        } catch (initError) {
                            console.warn(`Error during explicit initialization for '${collectionName}':`, initError.message);
                        }
                    } else {
                        console.warn(`Unexpected error checking collection '${collectionName}':`, error.message);
                    }
                }
            }
        }

        // --- Auth State Change Handler ---
        auth.onAuthStateChanged(async (user) => {
            console.log("Firebase Auth State Changed. Current user:", user ? user.uid : "None");
            if (user) {
                const userDocRef = db.collection('users').doc(user.uid);
                let userDoc;
                try {
                    userDoc = await userDocRef.get();
                } catch (error) {
                    console.error("Error fetching user document from Firestore:", error);
                    displayMessage(loginMessageArea, 'Problem fetching your data:', 'error');
                    auth.signOut();
                    return;
                }

                if (userDoc.exists) {
                    currentUserCategory = userDoc.data().role;
                    console.log(`User ${user.email || user.uid} logged in. Role: ${currentUserCategory}`);

                    if (currentUserCategory === 'admin') {
                        showSection(adminDashboardSection);
                        renderAdminDashboard(); // Call a function to show the default dashboard view
                    } else {
                        showSection(userPanelSection);
                        userPanelTitle.textContent = translations[currentLanguage]['User Panel']; // Update title based on language
                        loadUserProducts(currentUserCategory);
                        loadUserOrders(user.uid);
                        updateCartSummary();
                    }
                } else {
                    console.log(`User document for ${user.uid} not found. Attempting to create it.`);
                    // Only create a document for non-anonymous users on first login
                    if (!user.isAnonymous) {
                        try {
                            await userDocRef.set({
                                role: 'admin', // Default to admin if no doc exists for email login
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            currentUserCategory = 'admin';
                            console.log(`Admin user document created for ${user.email}. Role set to 'admin'.`);
                            displayMessage(loginMessageArea, 'Admin user document created. Role set to admin.', 'success');
                            showSection(adminDashboardSection);
                            renderAdminDashboard();
                        } catch (error) {
                            console.error("Error creating admin user document on first login:", error);
                            displayMessage(loginMessageArea, 'Admin setup error:', 'error');
                            auth.signOut();
                        }
                    } else {
                        console.warn("Anonymous user logged in but no role document found. Logging out.");
                        displayMessage(loginMessageArea, 'Unknown user category. Please log in again.', 'error');
                        auth.signOut();
                    }
                }
            } else {
                console.log("No user logged in. Showing login section.");
                showSection(loginSection);
                currentUserCategory = null;
                userCart = {};
                updateCartSummary();
                if (loginEmailInput) loginEmailInput.value = '';
                if (loginPasswordInput) loginPasswordInput.value = '';
                // Clear history state when logging out
                history.replaceState(null, '', '#login');
            }
        });

        // --- Login Handlers ---
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Admin login button clicked.");

                if (!loginEmailInput || !loginPasswordInput) {
                    console.error("Login input elements not found in DOM!");
                    displayMessage(loginMessageArea, 'Form elements not loaded.', 'error');
                    return;
                }

                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value;

                if (!email || !password) {
                    displayMessage(loginMessageArea, 'Email and password required.', 'error');
                    return;
                }

                console.log("Attempting admin login with email:", email);
                displayMessage(loginMessageArea, 'Login in progress... please wait.', 'info');

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    console.log("Firebase Auth successful! UID:", userCredential.user.uid);
                    // The auth.onAuthStateChanged listener will handle redirection
                    displayMessage(loginMessageArea, 'Login successful.', 'success');
                } catch (error) {
                    console.error("Firebase Login Error:", error);
                    displayMessage(loginMessageArea, `${translations[currentLanguage]['Login failed:']} ${error.message}`, 'error');
                }
            });
        }

        // Anonymous Login Handler
        async function handleAnonymousLogin(category, expectedPassword) {
            const password = prompt(translations[currentLanguage][`${category} Login`]); // Prompt in chosen language
            if (password === null) {
                displayMessage(loginMessageArea, 'Login cancelled.', 'info');
                return;
            }
            if (password === expectedPassword) {
                console.log(`Attempting anonymous login for category: ${category}`);
                displayMessage(loginMessageArea, 'Login in progress... please wait.', 'info');
                try {
                    const userCredential = await auth.signInAnonymously();
                    const user = userCredential.user;
                    console.log("Anonymous Auth successful! UID:", user.uid);

                    const userDocRef = db.collection('users').doc(user.uid);
                    await userDocRef.set({
                        role: category,
                        email: 'anonymous', // Store 'anonymous' as email for identification
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`Anonymous user role '${category}' set in Firestore.`);
                } catch (error) {
                    console.error("Anonymous login error:", error);
                    displayMessage(loginMessageArea, `${translations[currentLanguage]['Login failed:']} ${error.message}`, 'error');
                }
            } else {
                displayMessage(loginMessageArea, 'Wrong password.', 'error');
            }
        }

        if (kitchenLoginBtn) kitchenLoginBtn.addEventListener('click', () => handleAnonymousLogin('kitchen', 'KhamerK'));
        if (menLoginBtn) menLoginBtn.addEventListener('click', () => handleAnonymousLogin('men', 'KhamerM'));
        if (womenLoginBtn) womenLoginBtn.addEventListener('click', () => handleAnonymousLogin('women', 'KhamerF'));

        // --- Logout Handlers ---
        async function handleLogout() {
            console.log("Logout button clicked.");
            await auth.signOut();
            displayMessage(loginMessageArea, 'Logout successful.', 'success');
            // auth.onAuthStateChanged will handle showing login section
        }
        if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleLogout);
        if (userLogoutBtn) userLogoutBtn.addEventListener('click', handleLogout);
        if (navLogoutBtn) navLogoutBtn.addEventListener('click', handleLogout); // Global logout

        // --- Admin Panel Functionality ---

        // Function to render the main admin dashboard content (pending orders)
        function renderAdminDashboard() {
            loadAdminDashboard(); // This loads pending orders
            // Ensure the pending orders content div is visible
            document.getElementById('admin-dashboard-content').style.display = 'block';
        }

        // Load Dashboard (Pending Orders)
        async function loadAdminDashboard() {
            console.log("Loading admin dashboard (pending orders)...");
            pendingOrdersList.innerHTML = `<p>${translations[currentLanguage]['Loading Orders...']}</p>`;
            db.collection('orders').where('status', '==', 'pending').orderBy('orderDate', 'desc')
                .onSnapshot(snapshot => {
                    pendingOrdersList.innerHTML = '';
                    if (snapshot.empty) {
                        pendingOrdersList.innerHTML = `<p>${translations[currentLanguage]['No pending orders.']}</p>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id; // Still needed internally for operations
                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.classList.add('order-item');
                        orderItemDiv.innerHTML